<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å°æ¡ç  - Daniel_æ¸…å¯’çš„é‚®æ”¿å°ç«™</title>
    <link rel="icon" type="image/svg+xml" href="mail.svg">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    
    <!-- JsBarcodeåº“ ç”¨äºç”Ÿæˆæ¡å½¢ç  -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <header>
        <h1 style="font-size:2.6em;letter-spacing:3px;">Daniel_æ¸…å¯’çš„é‚®æ”¿å°ç«™</h1>
        <div style="font-size:22px;letter-spacing:1px;margin-top:8px;">ä¸­å›½é‚®æ”¿çˆ±å¥½è€…çš„å®¶å›­</div>
    </header>
    <nav>
        <a class="tab" href="index.html">å°ç«™ä¸»é¡µ</a>
        <a class="tab" href="calculator.html">é‚®èµ„è®¡ç®—</a>
        <a class="tab active" href="makecode.html">æ‰“å°æ¡ç </a>
        <a class="tab" href="postcode.html">é‚®ç¼–æŸ¥è¯¢</a>
        <a class="tab" href="download.html">èµ„æ–™ä¸‹è½½</a>
        <a class="tab" href="contact.html">è”ç³»æˆ‘ä»¬</a>
    </nav>
    <main>
        <section id="barcode" class="active">
            <h2>é‚®æ”¿æ¡ç æ‰“å°</h2>
            
            <!-- æ¨¡å¼åˆ‡æ¢é€‰é¡¹å¡ -->
            <div class="mode-tabs">
                <button id="validateModeBtn" class="mode-tab active" onclick="switchMode('validate')">éªŒè¯æ¡ç </button>
                <button id="generateModeBtn" class="mode-tab" onclick="switchMode('generate')">ç”Ÿæˆæ¡ç </button>
            </div>

            <!-- æ¨¡å¼1ï¼šéªŒè¯æ¡ç  -->
            <div id="validateMode" class="mode-container">
                <div class="barcode-form">
                    <label for="barcodeInput">è¾“å…¥é‚®æ”¿æ¡ç ï¼š</label>
                    <input type="text" id="barcodeInput" placeholder="ä¾‹å¦‚: 1021850131 æˆ– XA10001001421 æˆ– 70123456001531" maxlength="20">
                    <div style="font-size:12px; color:#666; margin-top:8px; text-align:left;">
                        <strong>æ¡ç æ ¼å¼è¯´æ˜ï¼š</strong><br>
                        â€¢ ç¬¬1-3ä½ï¼šä¸šåŠ¡ç§ç±»ä»£ç ï¼ˆå¦‚1ã€7ã€89ã€XAã€SAç­‰ï¼‰<br>
                        â€¢ ç¬¬4-11ä½ï¼šé‚®ä»¶åºåˆ—å·ï¼ˆ8ä½æ•°å­—ï¼‰<br>
                        â€¢ ç¬¬12ä½ï¼šæ ¡éªŒç ï¼ˆ1ä½æ•°å­—ï¼‰<br>
                        â€¢ ç¬¬13-14ä½ï¼šçœåˆ«ä»£ç ï¼ˆ2ä½æ•°å­—ï¼‰<br>
                        <br>
                        <strong>å¸¸è§ä¸šåŠ¡ä»£ç ï¼š</strong> 1(ç‰¹å¿«) 7(å¹³é‚®) 89(æ ‡å¿«) 9(åŒ…è£¹) X(ç»™æ®) S(å°åˆ·å“) P(æ™®é€šåŒ…) N(çº¦æŠ•) 90(æŠ¥åˆŠ)
                    </div>
                    <button id="confirmBtn" class="confirm-btn">ç¡®è®¤</button>
                </div>
            </div>

            <!-- æ¨¡å¼2ï¼šç”Ÿæˆæ¡ç  -->
            <div id="generateMode" class="mode-container" style="display: none;">
                <div class="barcode-form">
                    <label for="businessType">ä¸šåŠ¡ç§ç±»ä»£ç ï¼š</label>
                    <select id="businessType">
                        <option value="">-- é€‰æ‹©ä¸šåŠ¡ç±»å‹ --</option>
                        <optgroup label="â”â” ç‰¹å¿«/å¿«é€’ â”â”">
                        <option value="1">1 - ç‰¹å¿«ä¸“é€’</option>
                        <option value="89">89 - æ ‡å‡†å¿«é€’</option>
                        <option value="E">E - ç‰¹å¿«ä¸“é€’(é‡è¦ä»¶)</option>
                        </optgroup>
                        <optgroup label="â”â” å¿«é€’åŒ…è£¹ â”â”">
                        <option value="92">92 - å¿«é€’åŒ…è£¹</option>
                        <option value="93">93 - å¿«é€’åŒ…è£¹</option>
                        <option value="94">94 - å¯„é€’å¿«åŒ…</option>
                        <option value="95">95 - å¿«é€’åŒ…è£¹</option>
                        <option value="96">96 - å¿«é€’åŒ…è£¹</option>
                        <option value="97">97 - å¯„é€’å¿«åŒ…</option>
                        <option value="98">98 - å¯„é€’å¿«åŒ…</option>
                        <option value="99">99 - å¯„é€’å¿«åŒ…</option>
                        </optgroup>
                        <optgroup label="â”â” å¹³å¸¸é‚®ä»¶ â”â”">
                        <option value="70">70 - æ¡ç å¹³ä¿¡/å¹³åˆ·</option>
                        <option value="71">71 - æ¡ç å¹³ä¿¡/å¹³åˆ·</option>
                        <option value="72">72 - æ¡ç å¹³åˆ·</option>
                        <option value="7">7 - å¹³å¸¸é‚®ä»¶</option>
                        </optgroup>
                        <optgroup label="â”â” é¢„çº¦æŠ•é€’ â”â”">
                        <option value="8">8 - é¢„çº¦æŠ•é€’é‚®ä»¶</option>
                        <option value="88">88 - ä¸ªäººçº¦æŠ•è¯¦æƒ…å•</option>
                        <option value="N">N - çº¦æŠ•æŒ‚å·ä¿¡å‡½</option>
                        </optgroup>
                        <optgroup label="â”â” ç»™æ®ä¿¡å‡½ â”â”">
                        <option value="X">X - ç»™æ®ä¿¡å‡½</option>
                        <option value="XA">XA - ä¸ªäººç»™æ®ä¿¡å‡½</option>
                        <option value="XB">XB - å¤§å®—ç»™æ®ä¿¡å‡½</option>
                        <option value="H">H - æŒ‚å·ä¿¡å‡½(å•†å‡½)</option>
                        </optgroup>
                        <optgroup label="â”â” ç»™æ®å°åˆ·å“ â”â”">
                        <option value="S">S - ç»™æ®å°åˆ·å“</option>
                        <option value="SA">SA - ä¸ªäººæŒ‚åˆ·</option>
                        <option value="SB">SB - å¤§å®—æŒ‚åˆ·</option>
                        </optgroup>
                        <optgroup label="â”â” æ™®é€šåŒ…è£¹ â”â”">
                        <option value="P">P - æ™®é€šåŒ…è£¹</option>
                        <option value="PA">PA - è€å››è”é¢„åˆ¶å•</option>
                        <option value="PE">PE - æ–°å››è”é¢„åˆ¶å•</option>
                        <option value="PH">PH - æœºæ‰“é¢„åˆ¶å•</option>
                        <option value="9">9 - åŒ…è£¹/é‚®åŠ¡</option>
                        </optgroup>
                        <optgroup label="â”â” ç‰¹æ®Šä¸šåŠ¡ â”â”">
                        <option value="90">90 - æŠ¥åˆŠ</option>
                        <option value="BK">BK - æŠ¥åˆŠä¸“é€’</option>
                        <option value="NA">NA - è´ºç¤¼å¡</option>
                        <option value="Q">Q - çƒ­æ•é¢„åˆ¶å•</option>
                        <option value="LY">LY - ç¤¼ä»ªä¸“é€’</option>
                        </optgroup>
                        <optgroup label="â”â” å›½é™…ä¸šåŠ¡ â”â”">
                        <option value="PN">PN - å›½å†…ç»™æ®é‚®ä»¶</option>
                        </optgroup>
                    </select>
                    <input type="text" id="businessTypeCustom" placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰ä»£ç ï¼ˆ1-3ä½ï¼Œå¦‚1ã€7ã€89ã€PAç­‰ï¼‰" maxlength="3" style="margin-top:6px;">

                    <label for="sequenceNum" style="margin-top:12px;">é‚®ä»¶åºåˆ—å·ï¼š</label>
                    <input type="text" id="sequenceNum" placeholder="8ä½æ•°å­—ï¼Œå¦‚02185001" maxlength="8">
                    <div style="font-size:12px; color:#666; margin-top:4px;">
                        é‚®ä»¶åºåˆ—å·æ˜¯8ä½æ•°å­—çš„å”¯ä¸€ç¼–ç 
                    </div>

                    <label for="provinceCode" style="margin-top:12px;">çœåˆ«ä»£ç ï¼š</label>
                    <select id="provinceCode">
                        <option value="">-- é€‰æ‹©çœä»½ --</option>
                        <option value="11">11 - åŒ—äº¬</option>
                        <option value="12">12 - å¤©æ´¥</option>
                        <option value="13">13 - æ²³åŒ—</option>
                        <option value="14">14 - å±±è¥¿</option>
                        <option value="15">15 - å†…è’™å¤</option>
                        <option value="21">21 - è¾½å®</option>
                        <option value="22">22 - å‰æ—</option>
                        <option value="23">23 - é»‘é¾™æ±Ÿ</option>
                        <option value="31">31 - ä¸Šæµ·</option>
                        <option value="32">32 - æ±Ÿè‹</option>
                        <option value="33">33 - æµ™æ±Ÿ</option>
                        <option value="34">34 - å®‰å¾½</option>
                        <option value="35">35 - ç¦å»º</option>
                        <option value="36">36 - æ±Ÿè¥¿</option>
                        <option value="37">37 - å±±ä¸œ</option>
                        <option value="41">41 - æ²³å—</option>
                        <option value="42">42 - æ¹–åŒ—</option>
                        <option value="43">43 - æ¹–å—</option>
                        <option value="44">44 - å¹¿ä¸œ</option>
                        <option value="45">45 - å¹¿è¥¿</option>
                        <option value="46">46 - æµ·å—</option>
                        <option value="50">50 - é‡åº†</option>
                        <option value="51">51 - å››å·</option>
                        <option value="52">52 - è´µå·</option>
                        <option value="53">53 - äº‘å—</option>
                        <option value="54">54 - è¥¿è—</option>
                        <option value="61">61 - é™•è¥¿</option>
                        <option value="62">62 - ç”˜è‚ƒ</option>
                        <option value="63">63 - é’æµ·</option>
                        <option value="64">64 - å®å¤</option>
                        <option value="65">65 - æ–°ç–†</option>
                    </select>
                    <input type="text" id="provinceCodeCustom" placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰ä»£ç ï¼ˆ2æ•°å­—ï¼‰" maxlength="2" style="margin-top:6px;">

                    <button id="generateConfirmBtn" class="confirm-btn" style="margin-top:18px;">ç”Ÿæˆæ¡ç </button>
                </div>
            </div>

            <!-- æ ¡éªŒç»“æœæ˜¾ç¤ºåŒº -->
            <div id="resultArea" class="result-area" style="display: none;">
                <div class="status-item">
                    <span id="validateStatus" class="status-text">å•å·æ ¡éªŒä¸­...</span>
                </div>
                <div class="status-item" id="conflictCheckItem" style="display: none;">
                    <span id="conflictStatus" class="status-text">å•å·å†²çªæŸ¥è¯¢ä¸­...</span>
                </div>
                <div class="status-item" id="apiSourceItem" style="display: none; margin-top: 12px; padding: 8px; background: #f0f8ff; border-radius: 4px; font-size: 12px;">
                    <strong>ç‰©æµæŸ¥è¯¢æºï¼š</strong> <span id="apiSourceDisplay" style="color: #0066cc;"></span>
                </div>
              <!-- Kuaidi100 H5æŸ¥è¯¢å®¹å™¨ -->
              <div id="kuaidi100-container" style="display:none; margin-top:15px; border:1px solid #eee; border-radius:6px; overflow:hidden;">
                <iframe id="kuaidi-frame" src="" width="100%" height="500" frameborder="0" style="background:#fff;"></iframe>
              </div>
            </div>

            <!-- æ¡ç æ˜¾ç¤ºåŒº -->
            <div id="barcodeDisplay" class="barcode-display" style="display: none;">
                <div class="barcode-info">
                    <p>é‚®æ”¿æ¡ç å·: <strong id="barcodeNumber"></strong></p>
                </div>
                <div class="barcode-container">
                    <svg id="barcodeSvg"></svg>
                    <div id="barcodeText" class="barcode-text"></div>
                </div>
                <div class="print-button-area">
                    <button onclick="window.print()" class="print-btn">æ‰“å°</button>
                    <button onclick="downloadBarcode()" class="download-btn">ä¸‹è½½æ¡ç </button>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>
            æœ¬ç«™è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äººæ¬¡
            <span style="margin: 0 10px;">|</span>

            æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡
        </p>

        &copy; 2025 Daniel_æ¸…å¯’çš„é‚®æ”¿å°ç«™ | æœ¬ç«™éä¸­å›½é‚®æ”¿å®˜æ–¹ç½‘ç«™ï¼Œä»…ä¾›é‚®æ”¿çˆ±å¥½è€…å­¦ä¹ ä¸äº¤æµ
    </footer>

<!-- ä¸è’œå­ç½‘ç«™è®¿é—®é‡ç»Ÿè®¡è„šæœ¬ -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script>
// ====== è¯†åˆ«é‚®æ”¿å•å·ç±»å‹ ======
function identifyMailType(code) {
  const firstChar = code.charAt(0).toUpperCase();
  const firstTwo = code.substring(0, 2).toUpperCase();
  const firstThree = code.substring(0, 3).toUpperCase();
  
  // æ£€æŸ¥ä¸‰ä½å¼€å¤´
  if (firstThree === 'BK') return 'æŠ¥åˆŠä¸“é€’';
  if (firstThree === 'LY') return 'ç¤¼ä»ªä¸“é€’(å·²åŸºæœ¬å–æ¶ˆ)';
  if (firstThree === 'EC') return 'ä»£æ”¶è´§æ¬¾é¢„åˆ¶å•(åŸºæœ¬å–æ¶ˆ)';
  
  // æ£€æŸ¥ä¸¤ä½å¼€å¤´
  if (firstTwo === 'PA') return 'è€å››è”é¢„åˆ¶å•';
  if (firstTwo === 'PE') return 'æ–°å››è”é¢„åˆ¶å•';
  if (firstTwo === 'PH') return 'æœºæ‰“é¢„åˆ¶å•';
  if (firstTwo === 'XA') return 'ä¸ªäººç»™æ®ä¿¡å‡½';
  if (firstTwo === 'XB' || (firstChar === 'X' && firstTwo > 'XB')) return 'å¤§å®—ç»™æ®ä¿¡å‡½åŠè‡ªåˆ¶å·';
  if (firstTwo === 'SA') return 'ä¸ªäººæŒ‚åˆ·';
  if (firstTwo === 'SB' || (firstChar === 'S' && firstTwo > 'SB')) return 'å¤§å®—æŒ‚åˆ·åŠè‡ªåˆ¶å·';
  if (firstTwo === 'NA' || firstTwo === 'NB' || firstTwo === 'NC' || firstTwo === 'ND') return 'è´ºç¤¼å¡';
  if (firstTwo === 'NE') return 'è‡ªåˆ¶æ®µçº¦æŠ•æŒ‚å·ä¿¡å‡½';
  if (firstTwo === 'NA' || firstTwo === 'NB' || firstTwo === 'NC' || firstTwo === 'ND') return 'çº¦æŠ•æŒ‚å·ä¿¡å‡½';
  if (firstTwo === '70' || firstTwo === '71') return 'æ¡ç å¹³ä¿¡æˆ–æ¡ç å¹³åˆ·';
  if (firstTwo === '72') return 'æ¡ç å¹³åˆ·';
  if (firstTwo === '88') return 'ä¸ªäººçº¦æŠ•è¯¦æƒ…å•';
  if (firstTwo === '89') return 'æ ‡å‡†å¿«é€’';
  if (firstTwo === '90') return 'æŠ¥åˆŠ';
  if (firstTwo === '92' || firstTwo === '93' || firstTwo === '95' || firstTwo === '96') return 'å¿«é€’åŒ…è£¹';
  if (firstTwo === '94' || firstTwo === '97' || firstTwo === '98' || firstTwo === '99') return 'å¯„é€’å¿«åŒ…';
  
  // æ£€æŸ¥å•ä¸ªå­—ç¬¦å¼€å¤´
  if (firstChar === '1') return 'ç‰¹å¿«ä¸“é€’';
  if (firstChar === '5') return 'ç»æµå¿«é€’(å·²å–æ¶ˆ)';
  if (firstChar === '7') return 'å¹³å¸¸é‚®ä»¶';
  if (firstChar === '8') return 'é¢„çº¦æŠ•é€’é‚®ä»¶';
  if (firstChar === '9') return 'åŒ…è£¹/é‚®åŠ¡';
  if (firstChar === 'X') return 'ç»™æ®ä¿¡å‡½';
  if (firstChar === 'S') return 'ç»™æ®å°åˆ·å“';
  if (firstChar === 'P') return 'æ™®é€šåŒ…è£¹';
  if (firstChar === 'N') return 'çº¦æŠ•æŒ‚å·ä¿¡å‡½(å¤§å®—åŠå°‘éƒ¨åˆ†ä¸ªäºº)';
  if (firstChar === 'K') return 'å¿«é€’åŒ…è£¹(å·²åŸºæœ¬å–æ¶ˆ)';
  if (firstChar === 'E') return 'ç‰¹å¿«ä¸“é€’(è‹¹æœä»¶ï¼Œé‡è¦ä»¶)';
  if (firstChar === 'H') return 'æŒ‚å·ä¿¡å‡½(å•†å‡½)';
  if (firstChar === 'Q') return 'çƒ­æ•é¢„åˆ¶å•';
  
  return 'å…¶ä»–ä¸ºç”µå•†æ ‡å¿«æˆ–è‡ªåˆ¶å·';
}

// ====== ä¸‹è½½æ¡ç å›¾ç‰‡ ======
function downloadBarcode() {
  const barcodeNumber = document.getElementById('barcodeNumber').textContent;
  if (!barcodeNumber) {
    alert('è¯·å…ˆç”Ÿæˆæˆ–éªŒè¯æ¡ç ');
    return;
  }

  // è·å–SVGå…ƒç´ 
  const svgElement = document.getElementById('barcodeSvg');
  if (!svgElement) {
    alert('æ¡ç ä¸å­˜åœ¨');
    return;
  }

  // åˆ›å»ºcanvaså…ƒç´ 
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // è®¾ç½®canvaså¤§å°ï¼ˆSVGåŠ ä¸Šè¾¹è·ï¼‰
  const svgRect = svgElement.getBoundingClientRect();
  canvas.width = svgRect.width + 20;
  canvas.height = svgRect.height + 40;
  
  // å¡«å……ç™½è‰²èƒŒæ™¯
  ctx.fillStyle = '#FFFFFF';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // å°†SVGè½¬æ¢ä¸ºå›¾åƒ
  const svgString = new XMLSerializer().serializeToString(svgElement);
  const img = new Image();
  const blob = new Blob([svgString], { type: 'image/svg+xml' });
  const url = URL.createObjectURL(blob);
  
  img.onload = function() {
    ctx.drawImage(img, 10, 10, svgRect.width, svgRect.height);
    
    // ç»˜åˆ¶æ¡ç å·æ–‡å­—
    ctx.fillStyle = '#000000';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(barcodeNumber, canvas.width / 2, canvas.height - 10);
    
    // è½¬æ¢ä¸ºPNGå¹¶ä¸‹è½½
    canvas.toBlob(function(blob) {
      const downloadUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = downloadUrl;
      a.download = `barcode_${barcodeNumber}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(downloadUrl);
    });
    
    URL.revokeObjectURL(url);
  };
  
  img.onerror = function() {
    // å¦‚æœSVGè½¬æ¢å¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨canvasä¸‹è½½
    canvas.toBlob(function(blob) {
      const downloadUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = downloadUrl;
      a.download = `barcode_${barcodeNumber}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(downloadUrl);
    });
  };
  
  img.src = url;
}

// ====== æ¨¡å¼åˆ‡æ¢å‡½æ•° ======
function switchMode(mode) {
  const validateMode = document.getElementById('validateMode');
  const generateMode = document.getElementById('generateMode');
  const validateModeBtn = document.getElementById('validateModeBtn');
  const generateModeBtn = document.getElementById('generateModeBtn');
  
  if (mode === 'validate') {
    validateMode.style.display = 'block';
    generateMode.style.display = 'none';
    validateModeBtn.classList.add('active');
    generateModeBtn.classList.remove('active');
  } else {
    validateMode.style.display = 'none';
    generateMode.style.display = 'block';
    validateModeBtn.classList.remove('active');
    generateModeBtn.classList.add('active');
  }
  
  // éšè—ç»“æœåŒºåŸŸ
  document.getElementById('resultArea').style.display = 'none';
  document.getElementById('barcodeDisplay').style.display = 'none';
}

// ====== S10æ ¡éªŒç æ ¸å¿ƒå‡½æ•° ======
// å¯¹8ä½é‚®ä»¶åºåˆ—å·è®¡ç®—æ ¡éªŒç 
function computeS10CheckDigit(eightDigits) {
  if (!/^\d{8}$/.test(eightDigits)) {
    throw new Error("å‚æ•°å¿…é¡»æ˜¯8ä½æ•°å­—å­—ç¬¦ä¸²");
  }
  const weights = [8, 6, 4, 2, 3, 5, 9, 7];
  let sum = 0;
  for (let i = 0; i < 8; i++) {
    sum += Number(eightDigits[i]) * weights[i];
  }
  const r = sum % 11;
  let cd = 11 - r;
  if (cd === 10) cd = 0;
  else if (cd === 11) cd = 5;
  return cd;
}

// ====== å¹³ä¿¡(70/71/72) åŠ æƒæ¨¡11ï¼šå‰10ä½å‚ä¸æƒé‡ [6,0,8,6,4,2,3,5,9,7] ======
function computeFlatMailCheckDigit(firstTenDigits) {
  if (!/^\d{10}$/.test(firstTenDigits)) {
    throw new Error('å¹³ä¿¡æ ¡éªŒéœ€è¦å‰10ä½çº¯æ•°å­—');
  }
  const weights = [6, 0, 8, 6, 4, 2, 3, 5, 9, 7];
  let sum = 0;
  for (let i = 0; i < 10; i++) {
    sum += Number(firstTenDigits[i]) * weights[i];
  }
  const r = sum % 11;
  let cd = 11 - r;
  if (cd === 10) cd = 0;
  else if (cd === 11) cd = 5;
  return cd;
}

// ç»Ÿä¸€é€‰æ‹©æ­£ç¡®ç®—æ³•è®¡ç®—æ ¡éªŒä½
function computeChinaPostCheckDigit(businessType, sequenceNum) {
  const bt = (businessType || '').toString();
  if (bt === '70' || bt === '71' || bt === '72') {
    const firstTen = bt + sequenceNum;
    return computeFlatMailCheckDigit(firstTen);
  }
  return computeS10CheckDigit(sequenceNum);
}

// ====== éªŒè¯ä¸­å›½é‚®æ”¿æ¡ç  ======
// ä¸­å›½é‚®æ”¿æ¡ç æ ¼å¼ï¼š[1-3ä½ä¸šåŠ¡ç§ç±»ä»£ç ][8ä½é‚®ä»¶åºåˆ—å·][1ä½æ ¡éªŒç ][2ä½çœåˆ«ä»£ç ] = 12-14ä½
// ä¾‹å¦‚ï¼š1021850001331 æˆ– XA10001001421 æˆ– 7012345600131
function validateChinaPostBarcode(code) {
  if (typeof code !== 'string') {
    return { ok: false, reason: 'format', message: 'è¾“å…¥å¿…é¡»æ˜¯å­—ç¬¦ä¸²' };
  }
  
  const s = code.trim().toUpperCase();
  
  // æ£€æŸ¥æ ¼å¼ï¼š1-3ä½å­—æ¯æˆ–æ•°å­— + 8ä½æ•°å­— + 1ä½æ•°å­— + 2ä½æ•°å­— = 12-14ä½
  if (!/^[A-Z0-9]{1,3}\d{11}$/.test(s)) {
    return { 
      ok: false, 
      reason: 'format', 
      message: 'æ ¼å¼é”™è¯¯ï¼ä¸­å›½é‚®æ”¿æ¡ç æ ‡å‡†æ ¼å¼ä¸ºï¼š1-3ä½ä¸šåŠ¡ä»£ç +8ä½åºåˆ—å·+1ä½æ ¡éªŒç +2ä½çœåˆ«\nä¾‹å¦‚ï¼š1021850001331(ç‰¹å¿«) æˆ– XA10001001421(ç»™æ®ä¿¡å‡½) æˆ– 7012345600131(å¹³ä¿¡)\nå…¶ä¸­ï¼šç¬¬1-3ä½=ä¸šåŠ¡ç§ç±»ä»£ç ï¼Œç¬¬4-11ä½=é‚®ä»¶åºåˆ—å·ï¼Œç¬¬12ä½=æ ¡éªŒç ï¼Œç¬¬13-14ä½=çœåˆ«ä»£ç ' 
    };
  }
  
  // åŠ¨æ€è§£ææ¡ç é•¿åº¦
  let businessType, sequenceNum, checkDigitInCode, provinceCode;
  
  // å°è¯•ä¸åŒçš„é•¿åº¦ç»„åˆ
  for (let typeLen = 1; typeLen <= 3; typeLen++) {
    if (s.length === typeLen + 11) {
      businessType = s.slice(0, typeLen);
      sequenceNum = s.slice(typeLen, typeLen + 8);
      checkDigitInCode = Number(s[typeLen + 8]);
      provinceCode = s.slice(typeLen + 9, typeLen + 11);
      break;
    }
  }
  
  if (!businessType) {
    return { 
      ok: false, 
      reason: 'format', 
      message: 'æ¡ç é•¿åº¦ä¸ç¬¦åˆæ ‡å‡†ï¼ˆåº”ä¸º12-14ä½ï¼‰' 
    };
  }

  // ç‰¹ä¾‹ï¼š13ä½çº¯æ•°å­—æ¡ç ä¸è¿›è¡Œæ ¡éªŒï¼ˆæŒ‰ç”¨æˆ·éœ€æ±‚ï¼‰
  if (/^\d{13}$/.test(s)) {
    const mailType = identifyMailType(businessType);
    return {
      ok: true,
      businessType,
      mailType,
      sequenceNum,
      given: checkDigitInCode,
      computed: null,
      provinceCode,
      fullCode: s,
      details: {
        'ä¸šåŠ¡ä»£ç ': businessType,
        'é‚®ä»¶ç±»å‹': mailType,
        'é‚®ä»¶åºåˆ—å·': sequenceNum,
        'æ ¡éªŒç®—æ³•': 'è·³è¿‡æ ¡éªŒï¼ˆ13ä½çº¯æ•°å­—ï¼‰',
        'æ ¡éªŒç ': `${checkDigitInCode}âœ“(è·³è¿‡)`,
        'çœåˆ«ä»£ç ': provinceCode
      }
    };
  }
  
  try {
    // æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©æ­£ç¡®ç®—æ³•è®¡ç®—æ ¡éªŒç 
    const computed = computeChinaPostCheckDigit(businessType, sequenceNum);
    const isValid = computed === checkDigitInCode;
    const algoName = (businessType === '70' || businessType === '71' || businessType === '72')
      ? 'å¹³ä¿¡(70/71/72) åŠ æƒæ¨¡11'
      : 'UPU S10';

    // è¯†åˆ«é‚®ä»¶ç±»å‹
    const mailType = identifyMailType(businessType);

    const result = {
      ok: isValid,
      businessType: businessType,      // ä¸šåŠ¡ç§ç±»ä»£ç 
      mailType: mailType,              // é‚®ä»¶ç±»å‹
      sequenceNum: sequenceNum,        // é‚®ä»¶åºåˆ—å·
      given: checkDigitInCode,         // æ¡ç ä¸­ç»™å‡ºçš„æ ¡éªŒç 
      computed: computed,              // è®¡ç®—å‡ºçš„æ ¡éªŒç 
      provinceCode: provinceCode,      // çœåˆ«ä»£ç 
      fullCode: s,                     // å®Œæ•´æ¡ç 
      details: {
        'ä¸šåŠ¡ä»£ç ': businessType,
        'é‚®ä»¶ç±»å‹': mailType,
        'é‚®ä»¶åºåˆ—å·': sequenceNum,
        'æ ¡éªŒç®—æ³•': algoName,
        'æ ¡éªŒç ': `${checkDigitInCode}${isValid ? 'âœ“' : 'âœ—(' + computed + ')'}`,
        'çœåˆ«ä»£ç ': provinceCode
      }
    };

    if (!isValid) {
      result.message = `æ ¡éªŒå¤±è´¥ï¼šåº”ä¸º ${computed}ï¼ˆ${algoName}ï¼‰`;
      result.suggestedFullCode = `${businessType}${sequenceNum}${computed}${provinceCode}`;
    }

    return result;
  } catch (e) {
    return { ok: false, reason: 'è®¡ç®—é”™è¯¯', message: e.message };
  }
}

// ====== ç”Ÿæˆæ¡ç  ======
// ç”¨æˆ·è¾“å…¥ä¸šåŠ¡ç§ç±»ã€åºåˆ—å·ã€çœåˆ«ä»£ç ï¼Œç³»ç»Ÿè®¡ç®—æ ¡éªŒç åç”Ÿæˆå®Œæ•´æ¡ç 
function generateBarcodeFromInput() {
  let businessType = document.getElementById('businessType').value || document.getElementById('businessTypeCustom').value;
  const sequenceNum = document.getElementById('sequenceNum').value;
  let provinceCode = document.getElementById('provinceCode').value || document.getElementById('provinceCodeCustom').value;
  
  // éªŒè¯è¾“å…¥
  if (!businessType || businessType === '') {
    return { 
      ok: false, 
      message: 'è¯·é€‰æ‹©æˆ–è¾“å…¥ä¸šåŠ¡ç§ç±»ä»£ç ï¼ˆå¦‚1ã€7ã€89ã€XAã€SAç­‰ï¼‰' 
    };
  }
  
  // ä¸šåŠ¡ä»£ç å¯ä»¥æ˜¯1-3ä½ï¼ˆæ•°å­—æˆ–å­—æ¯ç»„åˆï¼‰
  if (!/^[A-Z0-9]{1,3}$/i.test(businessType)) {
    return { 
      ok: false, 
      message: 'ä¸šåŠ¡ç§ç±»ä»£ç æ ¼å¼ä¸æ­£ç¡®ï¼ˆ1-3ä½å­—æ¯æˆ–æ•°å­—ï¼‰' 
    };
  }
  businessType = businessType.toUpperCase();
  
  if (!sequenceNum || !/^\d{8}$/.test(sequenceNum)) {
    return { 
      ok: false, 
      message: 'é‚®ä»¶åºåˆ—å·å¿…é¡»æ˜¯8ä½æ•°å­—' 
    };
  }
  
  if (!provinceCode || !/^\d{2}$/.test(provinceCode)) {
    return { 
      ok: false, 
      message: 'çœåˆ«ä»£ç å¿…é¡»æ˜¯2ä½æ•°å­—' 
    };
  }
  
  try {
    // è®¡ç®—æ ¡éªŒç ï¼ˆæ ¹æ®ä¸šåŠ¡ç±»å‹è‡ªåŠ¨é€‰æ‹©ç®—æ³•ï¼‰
    const checkDigit = computeChinaPostCheckDigit(businessType, sequenceNum);
    
    // ç”Ÿæˆå®Œæ•´æ¡ç 
    const fullCode = businessType + sequenceNum + checkDigit + provinceCode;
    
    // è¯†åˆ«é‚®ä»¶ç±»å‹
    const mailType = identifyMailType(businessType);
    
    return {
      ok: true,
      businessType: businessType,
      mailType: mailType,
      sequenceNum: sequenceNum,
      checkDigit: checkDigit,
      provinceCode: provinceCode,
      fullCode: fullCode,
      details: {
        'ä¸šåŠ¡ä»£ç ': businessType,
        'é‚®ä»¶ç±»å‹': mailType,
        'é‚®ä»¶åºåˆ—å·': sequenceNum,
        'è®¡ç®—æ ¡éªŒç ': `${checkDigit}`,
        'çœåˆ«ä»£ç ': provinceCode
      }
    };
  } catch (e) {
    return { ok: false, message: 'ç”Ÿæˆæ¡ç æ—¶å‡ºé”™: ' + e.message };
  }
}

// ====== å¤šæºç‰©æµæŸ¥è¯¢APIï¼ˆå¸¦è¯¦ç»†è¯Šæ–­ä¿¡æ¯ï¼‰ ======
async function queryTrackingInfo(barcode) {
  const apiLog = [];
  
  // æ–¹æ¡ˆ1ï¼šå¿«é€’100å…è´¹æŸ¥è¯¢ï¼ˆæ–°æ¥å£ï¼Œæ”¯æŒJSONPï¼‰
  async function queryWithKuaidi100Free() {
    const apiName = 'å¿«é€’100å…è´¹ç‰ˆ';
    // æ³¨æ„ï¼šè¿™ä¸ªæ¥å£å¯èƒ½éœ€è¦åœ¨å®é™…éƒ¨ç½²æ—¶æ›¿æ¢ä¸ºæ‚¨è‡ªå·±ç”³è¯·çš„Key
    const url = `https://www.kuaidi100.com/query?type=yuantong&postid=${barcode}`;
    try {
      console.log(`[${apiName}] è¯·æ±‚: ${url}`);
      const response = await fetch(url, {
        method: 'GET',
        mode: 'cors'
      });
      console.log(`[${apiName}] å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
      
      if (response.ok) {
        const data = await response.json();
        console.log(`[${apiName}] æ•°æ®: `, data);
        apiLog.push(`âœ… ${apiName} æˆåŠŸ (HTTP ${response.status})`);
        return { ...data, _apiSource: apiName, _apiUrl: url };
      } else {
        apiLog.push(`âŒ ${apiName} å¤±è´¥ (HTTP ${response.status}: ${response.statusText})`);
        return null;
      }
    } catch (e) {
      console.log(`[${apiName}] é”™è¯¯:`, e);
      apiLog.push(`âŒ ${apiName} CORSé™åˆ¶: ${e.message}`);
      return null;
    }
  }
  
  // æ–¹æ¡ˆ2ï¼šä½¿ç”¨ä¸­å›½é‚®æ”¿å®˜æ–¹EMSæŸ¥è¯¢ï¼ˆå¯èƒ½éœ€è¦ä»£ç†ï¼‰
  async function queryWithEMSOfficial() {
    const apiName = 'EMSå®˜æ–¹æŸ¥è¯¢';
    const url = `https://www.ems.com.cn/queryList`;
    try {
      console.log(`[${apiName}] è¯·æ±‚: ${url}`);
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `mailNum=${barcode}`
      });
      console.log(`[${apiName}] å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
      
      if (response.ok) {
        const data = await response.json();
        console.log(`[${apiName}] æ•°æ®:`, data);
        apiLog.push(`âœ… ${apiName} æˆåŠŸ (HTTP ${response.status})`);
        return { ...data, _apiSource: apiName, _apiUrl: url };
      } else {
        apiLog.push(`âŒ ${apiName} å¤±è´¥ (HTTP ${response.status}: ${response.statusText})`);
        return null;
      }
    } catch (e) {
      console.log(`[${apiName}] é”™è¯¯:`, e);
      apiLog.push(`âŒ ${apiName} CORSé™åˆ¶: ${e.message}`);
      return null;
    }
  }

  // æ–¹æ¡ˆ3ï¼šä½¿ç”¨KuaiDi APIï¼ˆå¤‡ç”¨ï¼‰
  async function queryWithKuaidiAPI() {
    const apiName = 'KuaiDi API';
    const url = `https://api.kuaidiapi.cn/api?id=${barcode}&type=ems`;
    try {
      console.log(`[${apiName}] è¯·æ±‚: ${url}`);
      const response = await fetch(url, {
        headers: { 'User-Agent': 'Mozilla/5.0' }
      });
      console.log(`[${apiName}] å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
      
      if (response.ok) {
        const data = await response.json();
        console.log(`[${apiName}] æ•°æ®: `, data);
        apiLog.push(`âœ… ${apiName} æˆåŠŸ (HTTP ${response.status})`);
        return { ...data, _apiSource: apiName, _apiUrl: url };
      } else {
        apiLog.push(`âŒ ${apiName} å¤±è´¥ (HTTP ${response.status}: ${response.statusText})`);
        return null;
      }
    } catch (e) {
      console.log(`[${apiName}] é”™è¯¯:`, e);
      apiLog.push(`âŒ ${apiName} CORSé™åˆ¶: ${e.message}`);
      return null;
    }
  }
  
  // ä¾æ¬¡å°è¯•å„ä¸ªAPI
  console.log(`\n[ç‰©æµæŸ¥è¯¢] ========== å¼€å§‹æŸ¥è¯¢æ¡ç  ${barcode} ==========`);
  
  // ä¼˜å…ˆå°è¯•å¿«é€’100å…è´¹ç‰ˆ
  let result = await queryWithKuaidi100Free();
  if (result && !result._diagnosisMessage) {
    console.log('[ç‰©æµæŸ¥è¯¢] âœ… å¿«é€’100å…è´¹ç‰ˆæˆåŠŸè¿”å›æ•°æ®');
    console.log('[ç‰©æµæŸ¥è¯¢]', apiLog.join('\n'));
    return result;
  }
  
  // å°è¯•EMSå®˜æ–¹
  result = await queryWithEMSOfficial();
  if (result && !result._diagnosisMessage) {
    console.log('[ç‰©æµæŸ¥è¯¢] âœ… EMSå®˜æ–¹æˆåŠŸè¿”å›æ•°æ®');
    console.log('[ç‰©æµæŸ¥è¯¢]', apiLog.join('\n'));
    return result;
  }
  
  // å°è¯•KuaiDi API
  result = await queryWithKuaidiAPI();
  if (result && !result._diagnosisMessage) {
    console.log('[ç‰©æµæŸ¥è¯¢] âœ… KuaiDi APIæˆåŠŸè¿”å›æ•°æ®');
    console.log('[ç‰©æµæŸ¥è¯¢]', apiLog.join('\n'));
    return result;
  }
  
  console.log('[ç‰©æµæŸ¥è¯¢] âŒ æ‰€æœ‰APIéƒ½æ— æ³•è¿æ¥!');
  console.log('[ç‰©æµæŸ¥è¯¢] è¯Šæ–­æ—¥å¿—:');
  console.log(apiLog.join('\n'));
  console.log('[ç‰©æµæŸ¥è¯¢] ==========================================\n');
  
  // è¿”å›CORSé—®é¢˜è¯´æ˜å’Œè§£å†³æ–¹æ¡ˆ
  return {
    _apiSource: 'æ‰€æœ‰APIå—CORSé™åˆ¶',
    _apiLog: apiLog,
    _diagnosisMessage: 'âš ï¸ æµè§ˆå™¨CORSè·¨åŸŸé™åˆ¶\n\næ‰€æœ‰ç‰©æµæŸ¥è¯¢APIéƒ½è¢«æµè§ˆå™¨å®‰å…¨ç­–ç•¥é˜»æ­¢ã€‚\n\nâœ… æ¨èè§£å†³æ–¹æ¡ˆï¼š\n1. ã€æœ€ç®€å•ã€‘æ‰‹åŠ¨éªŒè¯ï¼šç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·³è½¬åˆ°å¿«é€’100æŸ¥è¯¢\n2. ã€éƒ¨ç½²åã€‘ä½¿ç”¨åç«¯ä»£ç†æœåŠ¡å™¨è½¬å‘APIè¯·æ±‚\n3. ã€å¼€å‘ç¯å¢ƒã€‘å®‰è£…æµè§ˆå™¨CORSæ’ä»¶ï¼ˆä»…æµ‹è¯•ç”¨ï¼‰\n\nğŸ’¡ å½“å‰æ¡ç æ ¼å¼å·²éªŒè¯é€šè¿‡ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ï¼š\nâ€¢ è·³è¿‡å†²çªæ£€æŸ¥ï¼Œç›´æ¥ç”Ÿæˆæ¡ç \nâ€¢ æ‰‹åŠ¨åœ¨å¿«é€’100ç½‘ç«™æŸ¥è¯¢åå†ç¡®è®¤'
  };
}

// ====== æ£€æŸ¥æ¡ç å†²çªï¼ˆè¿”å›APIæ¥æºå’Œè¯Šæ–­ä¿¡æ¯ï¼‰ ======
async function checkBarcodeConflict(barcode) {
  try {
    console.log(`[å†²çªæ£€æŸ¥] å¼€å§‹æ£€æŸ¥æ¡ç : ${barcode}`);
    
    // æ˜¾ç¤ºæŸ¥è¯¢ä¸­çš„ä¿¡æ¯
    const conflictStatus = document.getElementById('conflictStatus');
    if (conflictStatus) {
      conflictStatus.textContent = 'æ­£åœ¨æŸ¥è¯¢ç‰©æµæ•°æ®åº“...ï¼ˆæœ€å¤š5ç§’ï¼‰';
    }
    
    // ä½¿ç”¨å¿«é€’100 H5åµŒå…¥æ–¹å¼ï¼Œä¸å†ç›´æ¥è°ƒç”¨API
    // åŠ è½½iframeåˆ°é¡µé¢ï¼Œè¦æ±‚ç”¨æˆ·äººå·¥ç¡®è®¤æ— åœ¨é€”ç‰©æµåå†ç»§ç»­
    const container = document.getElementById('kuaidi100-container');
    const iframe = document.getElementById('kuaidi-frame');
    const queryUrl = `https://m.kuaidi100.com/result.jsp?nu=${barcode}`;
    if (iframe && container) {
      iframe.src = queryUrl;
      container.style.display = 'block';
    }
    
    return {
      ok: true,
      conflicted: false,
      message: 'âœ… å·²è½½å…¥å®æ—¶ç‰©æµæ•°æ®ï¼Œè¯·åœ¨ä¸‹æ–¹çª—å£ç¡®è®¤â€œæ— ç‰©æµä¿¡æ¯â€åå†ç»§ç»­',
      statusText: 'åµŒå…¥æŸ¥è¯¢',
      apiSource: 'å¿«é€’100(H5)',
      embedded: true,
      requireManualConfirm: true
    };
    
  } catch (error) {
    console.error('[å†²çªæ£€æŸ¥] æŸ¥è¯¢å‡ºé”™:', error);
    return {
      ok: true,
      conflicted: false,
      message: 'âš  ç‰©æµæŸ¥è¯¢å¤±è´¥ï¼Œä½†æ¡ç æ ¼å¼æœ‰æ•ˆã€‚å»ºè®®ç¨åå†æ¬¡ç¡®è®¤',
      statusText: 'æŸ¥è¯¢å¤±è´¥',
      apiSource: 'æŸ¥è¯¢å¼‚å¸¸'
    };
  }
}

// ====== ç”Ÿæˆæ¡ç å›¾ç‰‡ ======
function generateBarcode(barcodeNumber) {
  try {
    JsBarcode("#barcodeSvg", barcodeNumber, {
      format: "CODE128",
      width: 2,
      height: 100,
      displayValue: false,
      margin: 0
    });
    document.getElementById('barcodeText').textContent = barcodeNumber;
  } catch (e) {
    console.error('æ¡ç ç”Ÿæˆå¤±è´¥:', e);
  }
}

// ====== æ‰‹åŠ¨ç¡®è®¤åç»§ç»­æ˜¾ç¤ºæ¡ç  ======
function proceedAfterManualConfirm(fullCode) {
  const resultArea = document.getElementById('resultArea');
  const barcodeDisplay = document.getElementById('barcodeDisplay');
  if (resultArea && barcodeDisplay) {
    resultArea.style.display = 'none';
    barcodeDisplay.style.display = 'block';
    document.getElementById('barcodeNumber').textContent = fullCode;
    generateBarcode(fullCode);
  }
}

// ====== å–æ¶ˆå¹¶è¿”å›è¾“å…¥é¡µ ======
function cancelManualConfirm() {
  const resultArea = document.getElementById('resultArea');
  const barcodeDisplay = document.getElementById('barcodeDisplay');
  const container = document.getElementById('kuaidi100-container');
  const iframe = document.getElementById('kuaidi-frame');
  const apiSourceItem = document.getElementById('apiSourceItem');
  const conflictStatus = document.getElementById('conflictStatus');

  if (iframe) iframe.src = '';
  if (container) container.style.display = 'none';
  if (apiSourceItem) apiSourceItem.style.display = 'none';

  if (conflictStatus) {
    conflictStatus.textContent = 'å·²å–æ¶ˆï¼Œè¿”å›è¾“å…¥é¡µ';
  }

  if (resultArea) resultArea.style.display = 'none';
  if (barcodeDisplay) barcodeDisplay.style.display = 'none';

  // å°†ç„¦ç‚¹è¿”å›åˆ°å½“å‰æ¨¡å¼çš„è¾“å…¥æ¡†ï¼Œä¾¿äºé‡æ–°æ“ä½œ
  const validateModeVisible = document.getElementById('validateMode').style.display !== 'none';
  if (validateModeVisible) {
    const input = document.getElementById('barcodeInput');
    if (input) input.focus();
  } else {
    const seq = document.getElementById('sequenceNum');
    if (seq) seq.focus();
  }
}

// ====== æ ¼å¼åŒ–ç»†èŠ‚ä¿¡æ¯æ˜¾ç¤º ======
function formatBarcodeDetails(details) {
  let html = '<table style="width:100%; border-collapse:collapse; font-size:14px; margin-top:12px;">';
  for (const [key, value] of Object.entries(details)) {
    html += `<tr style="border-bottom:1px solid #e0e0e0;">
      <td style="padding:8px; font-weight:bold; width:30%; color:var(--green);">${key}</td>
      <td style="padding:8px; color:#333;">${value}</td>
    </tr>`;
  }
  html += '</table>';
  return html;
}

// ====== å¤„ç†éªŒè¯æ¡ç  ======
async function handleBarcodeValidate() {
  const input = document.getElementById('barcodeInput').value;
  const resultArea = document.getElementById('resultArea');
  const validateStatus = document.getElementById('validateStatus');
  const conflictCheckItem = document.getElementById('conflictCheckItem');
  const conflictStatus = document.getElementById('conflictStatus');
  const barcodeDisplay = document.getElementById('barcodeDisplay');

  if (!input.trim()) {
    alert('è¯·è¾“å…¥é‚®æ”¿æ¡ç ');
    return;
  }

  // æ˜¾ç¤ºç»“æœåŒºåŸŸ
  resultArea.style.display = 'block';
  barcodeDisplay.style.display = 'none';
  validateStatus.innerHTML = 'å•å·æ ¡éªŒä¸­...';
  conflictCheckItem.style.display = 'none';

  // ç¬¬ä¸€æ­¥ï¼šæ ¡éªŒæ¡ç 
  await new Promise(resolve => setTimeout(resolve, 800));

  const validateResult = validateChinaPostBarcode(input);
  
  if (!validateResult.ok) {
    validateStatus.innerHTML = `âŒ å•å·æ ¡éªŒå¤±è´¥ï¼š<br><span style="font-size:13px; color:#666; margin-top:6px; display:block;">${validateResult.message || validateResult.reason || 'æœªçŸ¥é”™è¯¯'}</span><br><span style="font-size:12px; color:#999; margin-top:8px;">ğŸ’¡ è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°(F12æŸ¥çœ‹)</span>`;
    console.log('[éªŒè¯å¤±è´¥è¯¦æƒ…]', validateResult);
    return;
  }

  // æ ¡éªŒé€šè¿‡ - æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
  const detailsHtml = formatBarcodeDetails(validateResult.details);
  validateStatus.innerHTML = `âœ… å•å·æ ¡éªŒæˆåŠŸï¼${detailsHtml}`;
  
  // ç¬¬äºŒæ­¥ï¼šå†²çªæŸ¥è¯¢
  conflictCheckItem.style.display = 'block';
  conflictStatus.textContent = 'æ­£åœ¨æŸ¥è¯¢ç‰©æµæ•°æ®åº“...ï¼ˆæœ€å¤š5ç§’ï¼‰';

  const conflictResult = await checkBarcodeConflict(validateResult.fullCode);

  if (conflictResult.conflicted) {
    // å•å·å†²çª - æ— æ³•ä½¿ç”¨
    conflictStatus.innerHTML = `âŒ <strong>${conflictResult.message}</strong><br><span style="font-size:12px;">æ£€æµ‹åˆ°æ­¤æ¡ç å·æ­£åœ¨è¿è¾“ä¸­ï¼Œä¸èƒ½é‡å¤ä½¿ç”¨</span>`;
    return;
  }

  // å¦‚æœä¸ºåµŒå…¥å¼æŸ¥è¯¢ï¼Œè¦æ±‚ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤åå†ç»§ç»­
  if (conflictResult.embedded && conflictResult.requireManualConfirm) {
    conflictStatus.innerHTML = `${conflictResult.message}
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button onclick="proceedAfterManualConfirm('${validateResult.fullCode}')" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">
        âœ… æˆ‘å·²ç¡®è®¤æ— åœ¨é€”ç‰©æµï¼Œç»§ç»­
      </button>
      <button onclick="cancelManualConfirm()" style="padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">
        âŒ æœ‰åœ¨é€”ç‰©æµï¼Œå–æ¶ˆå¹¶è¿”å›
      </button>
    </div>`;

    // æ˜¾ç¤ºAPIæ¥æº
    const apiSourceItem = document.getElementById('apiSourceItem');
    const apiSourceDisplay = document.getElementById('apiSourceDisplay');
    if (apiSourceItem && apiSourceDisplay) {
      apiSourceItem.style.display = 'block';
      apiSourceDisplay.textContent = conflictResult.apiSource;
    }
    return;
  }

  // å¦‚æœæ˜¯è¯Šæ–­ä¿¡æ¯ï¼ˆAPIæŸ¥è¯¢å¤±è´¥ï¼‰ï¼Œæ˜¾ç¤ºè¯Šæ–­å¸®åŠ©å’Œæ“ä½œé€‰é¡¹
  if (conflictResult.isDiagnosis) {
    const kuaidi100Url = `https://www.kuaidi100.com/chaxun?nu=${validateResult.fullCode}`;
    conflictStatus.innerHTML = `<span style="color:#f39c12; white-space: pre-wrap; font-size:12px;">${conflictResult.message}</span>
    <div style="margin-top:12px; padding:12px; background:#fff3cd; border-radius:4px; font-size:12px; color:#856404;">
      <strong>âš ï¸ ç”±äºæµè§ˆå™¨CORSé™åˆ¶ï¼Œæ— æ³•ç›´æ¥æŸ¥è¯¢ç‰©æµAPI</strong><br><br>
      <strong>è¯·é€‰æ‹©ä»¥ä¸‹æ“ä½œï¼š</strong><br>
      <div style="margin-top:10px; display: flex; gap: 8px; flex-wrap: wrap;">
        <button onclick="window.open('${kuaidi100Url}', '_blank')" style="padding:8px 16px; background:#0066cc; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">
          ğŸ” åœ¨å¿«é€’100æ‰‹åŠ¨æŸ¥è¯¢
        </button>
        <button onclick="document.getElementById('resultArea').style.display='none'; document.getElementById('barcodeDisplay').style.display='block'; document.getElementById('barcodeNumber').textContent='${validateResult.fullCode}'; generateBarcode('${validateResult.fullCode}');" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">
          âœ… è·³è¿‡æŸ¥è¯¢ï¼Œç›´æ¥ç”Ÿæˆæ¡ç 
        </button>
      </div>
      <div style="margin-top:10px; font-size:11px; color:#666;">
        æç¤ºï¼šç‚¹å‡»"æ‰‹åŠ¨æŸ¥è¯¢"åï¼Œå¦‚æœæ˜¾ç¤ºæ— ç‰©æµä¿¡æ¯ï¼Œåˆ™å¯æ”¾å¿ƒç”Ÿæˆæ¡ç 
      </div>
    </div>`;
    console.log('[è¯Šæ–­] APIæ—¥å¿—:', conflictResult.apiLog);
    console.log('[ç”¨æˆ·æç¤º] å·²æä¾›æ‰‹åŠ¨æŸ¥è¯¢å’Œè·³è¿‡é€‰é¡¹');
    return;
  }

  if (!conflictResult.ok) {
    // æŸ¥è¯¢å‡ºé”™ä½†æ¡ç æ ¼å¼æœ‰æ•ˆ
    conflictStatus.innerHTML = `âš  ${conflictResult.message}`;
  } else {
    // æŸ¥è¯¢æˆåŠŸä¸”æ— å†²çª
    conflictStatus.innerHTML = `âœ… ${conflictResult.message}`;
  }
  
  // æ˜¾ç¤ºAPIæ¥æº
  const apiSourceItem = document.getElementById('apiSourceItem');
  const apiSourceDisplay = document.getElementById('apiSourceDisplay');
  if (apiSourceItem && apiSourceDisplay && conflictResult.apiSource) {
    apiSourceItem.style.display = 'block';
    apiSourceDisplay.textContent = conflictResult.apiSource;
  }

  // ç­‰å¾…åå†æ˜¾ç¤ºæ¡ç 
  await new Promise(resolve => setTimeout(resolve, 1200));

  // éšè—çŠ¶æ€ï¼Œæ˜¾ç¤ºæ¡ç 
  resultArea.style.display = 'none';
  barcodeDisplay.style.display = 'block';
  document.getElementById('barcodeNumber').textContent = validateResult.fullCode;
  generateBarcode(validateResult.fullCode);
  
  // è¾“å‡ºéªŒè¯ä¿¡æ¯åˆ°æ§åˆ¶å°
  console.log('[éªŒè¯æˆåŠŸ]', {
    æ¡ç : validateResult.fullCode,
    ä¸šåŠ¡ä»£ç : validateResult.businessType,
    é‚®ä»¶ç±»å‹: validateResult.mailType,
    åºåˆ—å·: validateResult.sequenceNum,
    æ ¡éªŒç : `${validateResult.given}ï¼ˆè®¡ç®—å€¼ï¼š${validateResult.computed}ï¼‰`,
    çœä»½: validateResult.provinceCode,
    ç‰©æµæŸ¥è¯¢API: conflictResult.apiSource,
    ç‰©æµçŠ¶æ€: conflictResult.ok ? 'æ— å†²çª' : 'æœ‰é—®é¢˜'
  });
}

// ====== å¤„ç†ç”Ÿæˆæ¡ç  ======
async function handleBarcodeGenerate() {
  const resultArea = document.getElementById('resultArea');
  const validateStatus = document.getElementById('validateStatus');
  const conflictCheckItem = document.getElementById('conflictCheckItem');
  const conflictStatus = document.getElementById('conflictStatus');
  const barcodeDisplay = document.getElementById('barcodeDisplay');

  // ç”Ÿæˆæ¡ç 
  const generateResult = generateBarcodeFromInput();
  
  if (!generateResult.ok) {
    alert(generateResult.message);
    return;
  }

  // æ˜¾ç¤ºç»“æœåŒºåŸŸ
  resultArea.style.display = 'block';
  barcodeDisplay.style.display = 'none';
  validateStatus.innerHTML = 'æ­£åœ¨ç”Ÿæˆæ¡ç ...';
  conflictCheckItem.style.display = 'none';

  // ç­‰å¾…
  await new Promise(resolve => setTimeout(resolve, 600));

  // æ˜¾ç¤ºç”Ÿæˆçš„æ¡ç è¯¦æƒ…
  const detailsHtml = formatBarcodeDetails(generateResult.details);
  validateStatus.innerHTML = `âœ… æ¡ç ç”ŸæˆæˆåŠŸï¼${detailsHtml}`;
  
  // ç¬¬äºŒæ­¥ï¼šå†²çªæŸ¥è¯¢
  conflictCheckItem.style.display = 'block';
  conflictStatus.textContent = 'æ­£åœ¨æŸ¥è¯¢ç‰©æµæ•°æ®åº“...ï¼ˆæœ€å¤š5ç§’ï¼‰';

  const conflictResult = await checkBarcodeConflict(generateResult.fullCode);

  if (conflictResult.conflicted) {
    // å•å·å†²çª - æ— æ³•ä½¿ç”¨
    conflictStatus.innerHTML = `âŒ <strong>${conflictResult.message}</strong><br><span style="font-size:12px;">æ£€æµ‹åˆ°æ­¤æ¡ç å·æ­£åœ¨è¿è¾“ä¸­ï¼Œè¯·é‡æ–°ç”Ÿæˆ</span>`;
    return;
  }

  // å¦‚æœä¸ºåµŒå…¥å¼æŸ¥è¯¢ï¼Œè¦æ±‚ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤åå†ç»§ç»­
  if (conflictResult.embedded && conflictResult.requireManualConfirm) {
    conflictStatus.innerHTML = `${conflictResult.message}
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button onclick="proceedAfterManualConfirm('${generateResult.fullCode}')" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">
        âœ… æˆ‘å·²ç¡®è®¤æ— åœ¨é€”ç‰©æµï¼Œç»§ç»­
      </button>
      <button onclick="cancelManualConfirm()" style="padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">
        âŒ æœ‰åœ¨é€”ç‰©æµï¼Œå–æ¶ˆå¹¶è¿”å›
      </button>
    </div>`;

    // æ˜¾ç¤ºAPIæ¥æº
    const apiSourceItem = document.getElementById('apiSourceItem');
    const apiSourceDisplay = document.getElementById('apiSourceDisplay');
    if (apiSourceItem && apiSourceDisplay) {
      apiSourceItem.style.display = 'block';
      apiSourceDisplay.textContent = conflictResult.apiSource;
    }
    return;
  }

  // å¦‚æœæ˜¯CORSè¯Šæ–­ä¿¡æ¯ï¼Œæä¾›æ‰‹åŠ¨æŸ¥è¯¢å’Œè·³è¿‡é€‰é¡¹
  if (conflictResult.isDiagnosis) {
    const kuaidi100Url = `https://www.kuaidi100.com/chaxun?nu=${generateResult.fullCode}`;
    conflictStatus.innerHTML = `<span style="color:#f39c12; white-space: pre-wrap; font-size:12px;">${conflictResult.message}</span>
    <div style="margin-top:12px; padding:12px; background:#fff3cd; border-radius:4px; font-size:12px; color:#856404;">
      <strong>âš ï¸ ç”±äºæµè§ˆå™¨CORSé™åˆ¶ï¼Œæ— æ³•ç›´æ¥æŸ¥è¯¢ç‰©æµAPI</strong><br><br>
      <strong>è¯·é€‰æ‹©ä»¥ä¸‹æ“ä½œï¼š</strong><br>
      <div style="margin-top:10px; display: flex; gap: 8px; flex-wrap: wrap;">
        <button onclick="window.open('${kuaidi100Url}', '_blank')" style="padding:8px 16px; background:#0066cc; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">
          ğŸ” åœ¨å¿«é€’100æ‰‹åŠ¨æŸ¥è¯¢
        </button>
        <button onclick="document.getElementById('resultArea').style.display='none'; document.getElementById('barcodeDisplay').style.display='block'; document.getElementById('barcodeNumber').textContent='${generateResult.fullCode}'; generateBarcode('${generateResult.fullCode}');" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">
          âœ… è·³è¿‡æŸ¥è¯¢ï¼Œç›´æ¥ç”Ÿæˆæ¡ç 
        </button>
      </div>
      <div style="margin-top:10px; font-size:11px; color:#666;">
        æç¤ºï¼šç‚¹å‡»"æ‰‹åŠ¨æŸ¥è¯¢"åï¼Œå¦‚æœæ˜¾ç¤ºæ— ç‰©æµä¿¡æ¯ï¼Œåˆ™å¯æ”¾å¿ƒç”Ÿæˆæ¡ç 
      </div>
    </div>`;
    console.log('[è¯Šæ–­] APIæ—¥å¿—:', conflictResult.apiLog);
    console.log('[ç”¨æˆ·æç¤º] å·²æä¾›æ‰‹åŠ¨æŸ¥è¯¢å’Œè·³è¿‡é€‰é¡¹');
    return;
  }

  if (!conflictResult.ok) {
    // æŸ¥è¯¢å‡ºé”™ä½†æ¡ç æ ¼å¼æœ‰æ•ˆ
    conflictStatus.innerHTML = `âš  ${conflictResult.message}`;
  } else {
    // æŸ¥è¯¢æˆåŠŸä¸”æ— å†²çª
    conflictStatus.innerHTML = `âœ… ${conflictResult.message}`;
  }
  
  // æ˜¾ç¤ºAPIæ¥æº
  const apiSourceItem = document.getElementById('apiSourceItem');
  const apiSourceDisplay = document.getElementById('apiSourceDisplay');
  if (apiSourceItem && apiSourceDisplay && conflictResult.apiSource) {
    apiSourceItem.style.display = 'block';
    apiSourceDisplay.textContent = conflictResult.apiSource;
  }

  // ç­‰å¾…åå†æ˜¾ç¤ºæ¡ç 
  await new Promise(resolve => setTimeout(resolve, 1200));

  // éšè—çŠ¶æ€ï¼Œæ˜¾ç¤ºæ¡ç 
  resultArea.style.display = 'none';
  barcodeDisplay.style.display = 'block';
  document.getElementById('barcodeNumber').textContent = generateResult.fullCode;
  generateBarcode(generateResult.fullCode);
  
  // è¾“å‡ºç”Ÿæˆä¿¡æ¯åˆ°æ§åˆ¶å°
  console.log('[ç”ŸæˆæˆåŠŸ]', {
    æ¡ç : generateResult.fullCode,
    ä¸šåŠ¡ä»£ç : generateResult.businessType,
    é‚®ä»¶ç±»å‹: generateResult.mailType,
    åºåˆ—å·: generateResult.sequenceNum,
    æ ¡éªŒç : generateResult.checkDigit,
    çœä»½: generateResult.provinceCode,
    ç‰©æµæŸ¥è¯¢API: conflictResult.apiSource,
    å†²çªçŠ¶æ€: conflictResult.conflicted ? 'å†²çª' : 'å¯ç”¨'
  });
}

<!-- å°†é¡µé¢åº•éƒ¨çš„ DOMContentLoaded äº‹ä»¶ç»‘å®šæ›¿æ¢ä¸ºä¸‹é¢æ­£ç¡®çš„ä»£ç å— -->
document.addEventListener('DOMContentLoaded', function() {
  // éªŒè¯æ¨¡å¼äº‹ä»¶
  document.getElementById('confirmBtn').addEventListener('click', handleBarcodeValidate);
  document.getElementById('barcodeInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      handleBarcodeValidate();
    }
  });

  // ç”Ÿæˆæ¨¡å¼äº‹ä»¶
  document.getElementById('generateConfirmBtn').addEventListener('click', handleBarcodeGenerate);

  // ä¸šåŠ¡ç§ç±»ä»£ç ï¼šé€‰æ‹©å’Œè‡ªå®šä¹‰çš„äº¤äº’
  document.getElementById('businessType').addEventListener('change', function() {
    if (this.value) {
      document.getElementById('businessTypeCustom').value = '';
    }
  });

  document.getElementById('businessTypeCustom').addEventListener('input', function() {
    if (this.value) {
      document.getElementById('businessType').value = '';
    }
  });

  // çœåˆ«ä»£ç ï¼šé€‰æ‹©å’Œè‡ªå®šä¹‰çš„äº¤äº’
  document.getElementById('provinceCode').addEventListener('change', function() {
    if (this.value) {
      document.getElementById('provinceCodeCustom').value = '';
    }
  });

  document.getElementById('provinceCodeCustom').addEventListener('input', function() {
    if (this.value) {
      document.getElementById('provinceCode').value = '';
    }
  });
});
</script>

</body>
</html>