<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ç¼–æŸ¥è¯¢ - Daniel_æ¸…å¯’çš„é‚®æ”¿å°ç«™</title>
    <link rel="icon" type="image/svg+xml" href="mail.svg">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <h1 style="font-size:2.6em;letter-spacing:3px;">Daniel_æ¸…å¯’çš„é‚®æ”¿å°ç«™</h1>
        <div style="font-size:22px;letter-spacing:1px;margin-top:8px;">ä¸­å›½é‚®æ”¿çˆ±å¥½è€…çš„å®¶å›­</div>
    </header>
    <nav>
        <a class="tab" href="index.html">å°ç«™ä¸»é¡µ</a>
        <a class="tab" href="calculator.html">é‚®èµ„è®¡ç®—</a>
        <a class="tab" href="makecode.html">æ‰“å°æ¡ç </a>
        <a class="tab active" href="postcode.html">é‚®ç¼–æŸ¥è¯¢</a>
        <a class="tab" href="download.html">èµ„æ–™ä¸‹è½½</a>
        <a class="tab" href="contact.html">è”ç³»æˆ‘ä»¬</a>
    </nav>
    <main>
        <section id="postcode" class="active">
            <h2>ä¸­å›½é‚®æ”¿ç¼–ç æŸ¥è¯¢</h2>
            
            <!-- æ¨¡å¼åˆ‡æ¢é€‰é¡¹å¡ -->
            <div class="mode-tabs">
                <button id="codeToAddressBtn" class="mode-tab active" onclick="switchQueryMode('codeToAddress')">é‚®ç¼–æŸ¥åœ°å€</button>
                <button id="addressToCodeBtn" class="mode-tab" onclick="switchQueryMode('addressToCode')">åœ°å€æŸ¥é‚®ç¼–</button>
            </div>

            <!-- æ¨¡å¼1ï¼šé‚®ç¼–æŸ¥åœ°å€ -->
            <div id="codeToAddressMode" class="mode-container">
                <div class="barcode-form">
                    <label for="postcodeInput">è¾“å…¥é‚®æ”¿ç¼–ç ï¼š</label>
                    <input type="text" id="postcodeInput" placeholder="è¯·è¾“å…¥6ä½é‚®æ”¿ç¼–ç ï¼Œä¾‹å¦‚ï¼š010010" maxlength="6">
                    <button id="queryCodeBtn" class="confirm-btn">æŸ¥è¯¢</button>
                </div>
            </div>

            <!-- æ¨¡å¼2ï¼šåœ°å€æŸ¥é‚®ç¼– -->
            <div id="addressToCodeMode" class="mode-container" style="display: none;">
                <div class="barcode-form">
                    <label>é€‰æ‹©çœå¸‚ï¼ˆå¯é€‰ï¼Œæ¨èåŠ é€ŸæŸ¥è¯¢ï¼‰ï¼š</label>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
                      <select id="provinceSelect" style="min-width:160px;"><option value="">è¯·é€‰æ‹©çœä»½</option></select>
                      <select id="citySelect" style="min-width:160px;"><option value="">è¯·é€‰æ‹©åŸå¸‚</option></select>
                    </div>
                    <label for="addressInput">è¾“å…¥åœ°å€å…³é”®è¯ï¼š</label>
                    <input type="text" id="addressInput" placeholder="ä¾‹å¦‚ï¼šæ¡‚æ—è·¯100å· æˆ– å¸ˆèŒƒå¤§å­¦é‚®æ”¿æ‰€">
                    <div style="font-size:12px; color:#666; margin-top:8px; text-align:left;">
                        ğŸ’¡ æ”¯æŒæ™ºèƒ½åˆ†è¯ï¼šè¾“å…¥"è¾½å®çœæ²ˆé˜³å¸‚å’Œç¦è·¯"ä¼šè‡ªåŠ¨è¯†åˆ«ä¸º"è¾½å®çœ"+"æ²ˆé˜³å¸‚"+"å’Œç¦è·¯"<br>
                      âš–ï¸ æƒé‡åŒ¹é…ï¼šå‘½ä¸­çš„å­—æ®µè¶Šå¤šã€è¶Šç²¾ç¡®ï¼Œç»“æœæ’åºè¶Šé å‰
                    </div>
                    <button id="queryAddressBtn" class="confirm-btn">æŸ¥è¯¢</button>
                </div>
            </div>

            <!-- æŸ¥è¯¢ç»“æœæ˜¾ç¤ºåŒº -->
            <div id="queryResult" class="query-result" style="display: none;">
                <div id="resultContent"></div>
            </div>
        </section>
    </main>
    <footer>
        <p>
            æœ¬ç«™è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äººæ¬¡
            <span style="margin: 0 10px;">|</span>

            æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡
        </p>

        &copy; 2025 Daniel_æ¸…å¯’çš„é‚®æ”¿å°ç«™ | æœ¬ç«™éä¸­å›½é‚®æ”¿å®˜æ–¹ç½‘ç«™ï¼Œä»…ä¾›é‚®æ”¿çˆ±å¥½è€…å­¦ä¹ ä¸äº¤æµ
    </footer>

<!-- ä¸è’œå­ç½‘ç«™è®¿é—®é‡ç»Ÿè®¡è„šæœ¬ -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- çœå¸‚ç´¢å¼•ä¸åŸå¸‚å‰ç¼€æ˜ å°„ï¼ˆç”¨äºé«˜æ•ˆç¼©å°æŸ¥è¯¢èŒƒå›´ï¼‰ -->
<script src="code/province_city_list.js"></script>
<script src="code/province_city_prefixes.js"></script>

<script>
// ====== æ¨¡å¼åˆ‡æ¢å‡½æ•° ======
function switchQueryMode(mode) {
  const codeToAddressMode = document.getElementById('codeToAddressMode');
  const addressToCodeMode = document.getElementById('addressToCodeMode');
  const codeToAddressBtn = document.getElementById('codeToAddressBtn');
  const addressToCodeBtn = document.getElementById('addressToCodeBtn');
  
  if (mode === 'codeToAddress') {
    codeToAddressMode.style.display = 'block';
    addressToCodeMode.style.display = 'none';
    codeToAddressBtn.classList.add('active');
    addressToCodeBtn.classList.remove('active');
  } else {
    codeToAddressMode.style.display = 'none';
    addressToCodeMode.style.display = 'block';
    codeToAddressBtn.classList.remove('active');
    addressToCodeBtn.classList.add('active');
  }
  
  // éšè—ç»“æœåŒºåŸŸ
  document.getElementById('queryResult').style.display = 'none';
}

// ====== é‚®ç¼–æŸ¥åœ°å€ ======
async function queryByPostcode() {
  const postcode = document.getElementById('postcodeInput').value.trim();
  const resultArea = document.getElementById('queryResult');
  const resultContent = document.getElementById('resultContent');
  
  if (!postcode || !/^\d{6}$/.test(postcode)) {
    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½é‚®æ”¿ç¼–ç ');
    return;
  }
  
  resultArea.style.display = 'block';
  resultContent.innerHTML = '<p style="text-align:center; color:#666;">æ­£åœ¨æŸ¥è¯¢...</p>';
  
  try {
    // å°è¯•åŠ è½½å¯¹åº”çš„JSONæ–‡ä»¶
    const response = await fetch(`code/${postcode}.json`);
    
    if (!response.ok) {
      resultContent.innerHTML = `<p style="text-align:center; color:#f39c12;">âŒ æœªæ‰¾åˆ°é‚®ç¼– <strong>${postcode}</strong> çš„ç›¸å…³ä¿¡æ¯</p>`;
      return;
    }
    
    const data = await response.json();
    
    if (!data || data.length === 0) {
      resultContent.innerHTML = `<p style="text-align:center; color:#f39c12;">âŒ é‚®ç¼– <strong>${postcode}</strong> æš‚æ— è¯¦ç»†åœ°å€ä¿¡æ¯</p>`;
      return;
    }
    
    // æ˜¾ç¤ºç»“æœ
    let html = `<h3 style="color:var(--green); margin-top:0;">é‚®ç¼– ${postcode} å¯¹åº”çš„é‚®æ”¿ç½‘ç‚¹ï¼š</h3>`;
    html += '<div style="max-height:500px; overflow-y:auto;">';
    
    data.forEach((item, index) => {
      html += `
        <div style="background:#f9fbe7; border-radius:8px; padding:16px; margin-bottom:12px; border-left:4px solid var(--green);">
          <div style="font-size:18px; font-weight:bold; color:var(--green); margin-bottom:8px;">
            ${index + 1}. ${item.name}
          </div>
          <div style="margin-bottom:4px;">
            <strong>çœå¸‚åŒºï¼š</strong>${item.province} ${item.city} ${item.area}
          </div>
          <div style="margin-bottom:4px;">
            <strong>è¯¦ç»†åœ°å€ï¼š</strong>${item.address}
          </div>
          <div style="margin-bottom:4px;">
            <strong>è”ç³»ç”µè¯ï¼š</strong>${item.phone}
          </div>
          <div>
            <strong>é‚®æ”¿ç¼–ç ï¼š</strong><span style="color:var(--light-green); font-size:18px; font-weight:bold;">${item.code}</span>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    resultContent.innerHTML = html;
    
  } catch (error) {
    console.error('æŸ¥è¯¢å‡ºé”™:', error);
    resultContent.innerHTML = `<p style="text-align:center; color:#e74c3c;">âŒ æŸ¥è¯¢å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•</p>`;
  }
}

// ====== çœä»½åˆ°é‚®ç¼–å‰ç¼€çš„æ˜ å°„ ======
const provinceToPostcodePrefix = {
  'åŒ—äº¬': ['10', '11', '12'],
  'å¤©æ´¥': ['30'],
  'æ²³åŒ—': ['05', '06', '07'],
  'å±±è¥¿': ['03', '04'],
  'å†…è’™å¤': ['01', '02'],
  'è¾½å®': ['11', '12', '13'],
  'å‰æ—': ['13', '14'],
  'é»‘é¾™æ±Ÿ': ['15', '16', '17'],
  'ä¸Šæµ·': ['20'],
  'æ±Ÿè‹': ['21', '22', '23', '24', '25'],
  'æµ™æ±Ÿ': ['31', '32', '33'],
  'å®‰å¾½': ['23', '24', '25', '26', '27'],
  'ç¦å»º': ['35', '36', '37'],
  'æ±Ÿè¥¿': ['33', '34'],
  'å±±ä¸œ': ['25', '26', '27', '28'],
  'æ²³å—': ['45', '46', '47', '48', '49'],
  'æ¹–åŒ—': ['43', '44'],
  'æ¹–å—': ['41', '42', '43'],
  'å¹¿ä¸œ': ['51', '52', '53', '54'],
  'å¹¿è¥¿': ['53', '54', '55'],
  'æµ·å—': ['57'],
  'é‡åº†': ['40', '41'],
  'å››å·': ['61', '62', '63', '64'],
  'è´µå·': ['55', '56', '57'],
  'äº‘å—': ['65', '66', '67'],
  'è¥¿è—': ['85', '86'],
  'é™•è¥¿': ['71', '72'],
  'ç”˜è‚ƒ': ['73', '74'],
  'é’æµ·': ['81', '82'],
  'å®å¤': ['75'],
  'æ–°ç–†': ['83', '84']
};

// ====== å¸¸ç”¨åœ°åç¼©å†™æ˜ å°„ ======
const abbreviationMap = {
  'å¸ˆå¤§': ['å¸ˆèŒƒå¤§å­¦', 'å¸ˆå¤§', 'å¸ˆèŒƒ'],
  'äº¤å¤§': ['äº¤é€šå¤§å­¦', 'äº¤å¤§'],
  'ç†å·¥': ['ç†å·¥å¤§å­¦', 'ç†å·¥å­¦é™¢', 'ç†å·¥'],
  'è´¢å¤§': ['è´¢ç»å¤§å­¦', 'è´¢å¤§'],
  'åŒ»å¤§': ['åŒ»ç§‘å¤§å­¦', 'åŒ»å­¦é™¢', 'åŒ»å¤§'],
  'å†œå¤§': ['å†œä¸šå¤§å­¦', 'å†œå¤§'],
  'å·¥å¤§': ['å·¥ä¸šå¤§å­¦', 'å·¥å¤§'],
  'ç§‘å¤§': ['ç§‘æŠ€å¤§å­¦', 'ç§‘å¤§'],
  'é‚®ç”µ': ['é‚®ç”µå¤§å­¦', 'é‚®ç”µå­¦é™¢', 'é‚®ç”µ'],
  'æ°‘å¤§': ['æ°‘æ—å¤§å­¦', 'æ°‘å¤§'],
  'ä½“é™¢': ['ä½“è‚²å­¦é™¢', 'ä½“é™¢'],
  'éŸ³é™¢': ['éŸ³ä¹å­¦é™¢', 'éŸ³é™¢'],
  'ç¾é™¢': ['ç¾æœ¯å­¦é™¢', 'ç¾é™¢']
};

// ====== çœä»½ã€åŸå¸‚ã€åŒºåŸŸå…³é”®è¯åˆ—è¡¨ ======
const provinceKeywords = ['åŒ—äº¬', 'å¤©æ´¥', 'æ²³åŒ—', 'å±±è¥¿', 'å†…è’™å¤', 'è¾½å®', 'å‰æ—', 'é»‘é¾™æ±Ÿ', 
  'ä¸Šæµ·', 'æ±Ÿè‹', 'æµ™æ±Ÿ', 'å®‰å¾½', 'ç¦å»º', 'æ±Ÿè¥¿', 'å±±ä¸œ', 'æ²³å—', 'æ¹–åŒ—', 'æ¹–å—', 
  'å¹¿ä¸œ', 'å¹¿è¥¿', 'æµ·å—', 'é‡åº†', 'å››å·', 'è´µå·', 'äº‘å—', 'è¥¿è—', 'é™•è¥¿', 'ç”˜è‚ƒ', 
  'é’æµ·', 'å®å¤', 'æ–°ç–†'];

// ä½¿ç”¨å¤–éƒ¨ç”Ÿæˆçš„ window.PROVINCE_CITY_PREFIXES æ›¿ä»£æ‰‹å†™æ˜ å°„

const citySuffixes = ['å¸‚', 'åœ°åŒº', 'å·', 'ç›Ÿ'];
const districtSuffixes = ['åŒº', 'å¿', 'å¸‚', 'æ——'];

// ====== æ™ºèƒ½åˆ†è¯å‡½æ•° ======
function smartSegmentation(input) {
  console.log('ğŸ“ å¼€å§‹åˆ†è¯ï¼Œè¾“å…¥:', input);
  
  // å…ˆæŒ‰ç©ºæ ¼åˆ†å‰²
  const spaceSplit = input.trim().split(/\s+/);
  
  // å¦‚æœæœ‰å¤šä¸ªç©ºæ ¼åˆ†è¯ï¼Œç›´æ¥è¿”å›
  if (spaceSplit.length > 1) {
    console.log('âœ… ç©ºæ ¼åˆ†è¯ç»“æœ:', spaceSplit);
    return spaceSplit.filter(s => s.length > 0);
  }
  
  // å•ä¸ªå­—ç¬¦ä¸²ï¼Œéœ€è¦æ™ºèƒ½åˆ†è¯
  const text = input.trim();
  const segments = [];
  let currentIndex = 0;
  
  console.log(`å¼€å§‹è§£ææ–‡æœ¬ï¼Œæ€»é•¿åº¦: ${text.length}`);
  
  while (currentIndex < text.length) {
    let matched = false;
    const remaining = text.slice(currentIndex);
    console.log(`å½“å‰ä½ç½®: ${currentIndex}, å‰©ä½™æ–‡æœ¬: "${remaining}"`);
    
    // 1. å°è¯•åŒ¹é…çœä»½ï¼ˆæœ€é•¿ä¼˜å…ˆï¼‰
    for (const province of provinceKeywords) {
      const provinceWithSuffix = province + 'çœ';
      const autonomousRegion = province + 'è‡ªæ²»åŒº';
      
      if (remaining.startsWith(provinceWithSuffix)) {
        segments.push(provinceWithSuffix);
        console.log(`  âœ… åŒ¹é…çœä»½: ${provinceWithSuffix}`);
        currentIndex += provinceWithSuffix.length;
        matched = true;
        break;
      } else if (remaining.startsWith(autonomousRegion)) {
        segments.push(autonomousRegion);
        console.log(`  âœ… åŒ¹é…è‡ªæ²»åŒº: ${autonomousRegion}`);
        currentIndex += autonomousRegion.length;
        matched = true;
        break;
      } else if (remaining.startsWith(province)) {
        segments.push(province);
        console.log(`  âœ… åŒ¹é…çœä»½(æ— åç¼€): ${province}`);
        currentIndex += province.length;
        matched = true;
        break;
      }
    }
    
    if (matched) continue;
    
    // 2. å°è¯•åŒ¹é…åŸå¸‚ï¼ˆxxå¸‚/xxåœ°åŒº/xxå·/xxç›Ÿï¼‰
    for (let len = 6; len >= 2; len--) {
      if (len <= remaining.length) {
        const candidate = remaining.slice(0, len);
        const lastChar = candidate[candidate.length - 1];
        
        if (citySuffixes.includes(lastChar)) {
          segments.push(candidate);
          console.log(`  âœ… åŒ¹é…åŸå¸‚: ${candidate}`);
          currentIndex += len;
          matched = true;
          break;
        }
      }
    }
    
    if (matched) continue;
    
    // 3. å°è¯•åŒ¹é…åŒº/å¿ï¼ˆxxåŒº/xxå¿ï¼‰
    for (let len = 5; len >= 2; len--) {
      if (len <= remaining.length) {
        const candidate = remaining.slice(0, len);
        const lastChar = candidate[candidate.length - 1];
        
        if (districtSuffixes.includes(lastChar)) {
          segments.push(candidate);
          console.log(`  âœ… åŒ¹é…åŒº/å¿: ${candidate}`);
          currentIndex += len;
          matched = true;
          break;
        }
      }
    }
    
    if (matched) continue;
    
    // 4. å°è¯•åŒ¹é…è¡—é“/è·¯ï¼ˆxxè·¯/xxè¡—/xxé“ï¼‰
    const roadSuffixes = ['è·¯', 'è¡—', 'é“', 'å··', 'é‡Œ', 'èƒ¡åŒ', 'å¤§é“', 'å¤§è¡—'];
    for (let len = 8; len >= 2; len--) {
      if (len <= remaining.length) {
        const candidate = remaining.slice(0, len);
        
        if (roadSuffixes.some(suffix => candidate.endsWith(suffix))) {
          segments.push(candidate);
          console.log(`  âœ… åŒ¹é…é“è·¯: ${candidate}`);
          currentIndex += len;
          matched = true;
          break;
        }
      }
    }
    
    if (matched) continue;
    
    // 5. å¦‚æœéƒ½ä¸åŒ¹é…ï¼Œå–2-4ä¸ªå­—ä½œä¸ºé€šç”¨è¯ç»„
    let foundWord = false;
    for (let len = 4; len >= 2; len--) {
      if (len <= remaining.length) {
        const word = remaining.slice(0, len);
        segments.push(word);
        console.log(`  âš ï¸ é€šç”¨è¯ç»„: ${word}`);
        currentIndex += len;
        foundWord = true;
        break;
      }
    }
    
    if (!foundWord) {
      // å‰©ä½™å­—ç¬¦å°‘äº2ä¸ªï¼Œå…¨éƒ¨ä½œä¸ºä¸€ä¸ªè¯
      if (remaining.length > 0) {
        segments.push(remaining);
        console.log(`  âš ï¸ å‰©ä½™éƒ¨åˆ†: ${remaining}`);
        currentIndex += remaining.length;
      }
      break;
    }
  }
  
  const result = segments.filter(s => s.length > 0);
  console.log('âœ… æœ€ç»ˆåˆ†è¯ç»“æœ:', result);
  return result;
}

// ====== çœå¸‚ä¸‹æ‹‰åˆ—è¡¨åˆå§‹åŒ– ======
function initProvinceCityDropdowns() {
  const provSel = document.getElementById('provinceSelect');
  const citySel = document.getElementById('citySelect');
  if (!provSel || !citySel) return;

  const data = (window.PROVINCE_CITY_LIST) || {};
  // çœä»½é€‰é¡¹
  provSel.innerHTML = '<option value="">è¯·é€‰æ‹©çœä»½</option>' +
    Object.keys(data).map(p => `<option value="${p}">${p}</option>`).join('');

  // åŸå¸‚é‡ç½®
  const resetCities = () => citySel.innerHTML = '<option value="">è¯·é€‰æ‹©åŸå¸‚</option>';
  resetCities();

  provSel.addEventListener('change', () => {
    const p = provSel.value;
    resetCities();
    if (p && data[p]) {
      citySel.innerHTML = '<option value="">è¯·é€‰æ‹©åŸå¸‚</option>' +
        data[p].map(c => `<option value="${c}">${c}</option>`).join('');
    }
  });
}

// åç§°è§„èŒƒåŒ–ï¼ˆå»æ‰å¸¸è§åç¼€ï¼Œä¾¿äºåŒ¹é…ï¼‰
function canonName(s) {
  return String(s || '').replace(/(çœ|å¸‚|åœ°åŒº|ç›Ÿ|å·|è‡ªæ²»å·|è‡ªæ²»åŒº|ç‰¹åˆ«è¡Œæ”¿åŒº)$/g, '');
}

// ====== æ‰©å±•æœç´¢å…³é”®è¯ï¼ˆå¤„ç†ç¼©å†™ï¼‰ ======
function expandKeywords(keywords) {
  const expanded = [];
  keywords.forEach(keyword => {
    expanded.push(keyword); // ä¿ç•™åŸå…³é”®è¯
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å·²çŸ¥ç¼©å†™
    if (abbreviationMap[keyword]) {
      expanded.push(...abbreviationMap[keyword]);
    }
  });
  return [...new Set(expanded)]; // å»é‡
}

// ====== è®¡ç®—ç›¸å…³æ€§è¯„åˆ† ======
function calculateRelevance(item, searchKeywords, expandedKeywords) {
  let score = 0;
  
  // æ„å»ºå„å­—æ®µçš„æœç´¢æ–‡æœ¬
  const province = item.province.toLowerCase();
  const city = item.city.toLowerCase();
  const area = item.area.toLowerCase();
  const name = item.name.toLowerCase();
  const address = item.address.toLowerCase();
  const fullText = province + city + area + name + address;
  
  // å®Œæ•´åœ°å€æ–‡æœ¬
  const addressOnly = address;
  
  searchKeywords.forEach((keyword, idx) => {
    const kw = keyword.toLowerCase();
    
    // ç²¾ç¡®åŒ¹é…åœ°å€å­—æ®µï¼ˆæœ€é«˜æƒé‡ï¼‰
    if (addressOnly.includes(kw)) {
      score += 100;
    }
    
    // åŒ¹é…é‚®å±€åç§°
    if (name.includes(kw)) {
      score += 50;
    }
    
    // åŒ¹é…åŒºåŸŸ
    if (area.includes(kw)) {
      score += 30;
    }
    
    // åŒ¹é…åŸå¸‚
    if (city.includes(kw)) {
      score += 20;
    }
    
    // åŒ¹é…çœä»½
    if (province.includes(kw)) {
      score += 10;
    }
    
    // åŒ¹é…æ‰©å±•å…³é”®è¯ï¼ˆç¼©å†™å±•å¼€ï¼‰
    expandedKeywords.forEach(expandedKw => {
      if (expandedKw !== kw && fullText.includes(expandedKw.toLowerCase())) {
        score += 40;
      }
    });
  });
  
  // å…³é”®è¯åŒ¹é…æ•°é‡åŠ æˆ
  const matchCount = searchKeywords.filter(kw => 
    fullText.includes(kw.toLowerCase())
  ).length;
  score += matchCount * 15;
  
  return score;
}

// ====== åœ°å€æŸ¥é‚®ç¼–ï¼ˆæ™ºèƒ½æœç´¢ï¼‰ ======
async function queryByAddress() {
  const keywords = document.getElementById('addressInput').value.trim();
  const resultArea = document.getElementById('queryResult');
  const resultContent = document.getElementById('resultContent');
  
  if (!keywords) {
    alert('è¯·è¾“å…¥åœ°å€å…³é”®è¯');
    return;
  }
  
  resultArea.style.display = 'block';
  resultContent.innerHTML = '<p style="text-align:center; color:#666;">æ­£åœ¨æ™ºèƒ½åˆ†è¯å¹¶æœç´¢é‚®ç¼–æ•°æ®åº“...<br><span style="font-size:12px; color:#999;">å·²æ£€æŸ¥ <span id="searchProgress">0</span> ä¸ªé‚®ç¼–</span></p>';
  
  try {
    const results = [];

    // ç»Ÿä¸€æ¸…æ´—ï¼šå»æ‰æ‰€æœ‰ç©ºç™½å­—ç¬¦ï¼ˆå«å…¨è§’ç©ºæ ¼/nbspï¼‰ï¼Œé¿å…å‡ºç°â€œè¾½å®çœ â€è¿™ç±»éšå½¢ç©ºæ ¼å¯¼è‡´åŒ¹é…å¤±è´¥
    const normalizeText = (s) => String(s ?? '')
      .toLowerCase()
      .replace(/[\s\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]+/g, '');
    
    // æ™ºèƒ½åˆ†è¯ + æ¸…æ´—ï¼ˆå»æ‰å¤šä½™ç©ºç™½ï¼‰
    const searchKeywords = smartSegmentation(keywords)
      .map(k => normalizeText(k))
      .filter(k => k.length > 0);
    console.log('ğŸ” æœç´¢å…³é”®è¯:', searchKeywords);
    
    // æ‰©å±•æœç´¢å…³é”®è¯ï¼ˆå¤„ç†ç¼©å†™ï¼‰
    const expandedKeywords = expandKeywords(searchKeywords)
      .map(k => normalizeText(k))
      .filter(k => k.length > 0);
    console.log('ğŸ“š æ‰©å±•å…³é”®è¯:', expandedKeywords);
    
    // æ™ºèƒ½è¯†åˆ«çœä»½/åŸå¸‚ï¼Œç¼©å°æœç´¢èŒƒå›´ï¼ˆä¼˜å…ˆä½¿ç”¨ä¸‹æ‹‰é€‰æ‹©ï¼‰
    let targetPrefixes = [];
    let foundProvince = null;
    let foundCity = null;

    const provSel = document.getElementById('provinceSelect');
    const citySel = document.getElementById('citySelect');
    const selProvince = provSel && provSel.value ? provSel.value : '';
    const selCity = citySel && citySel.value ? citySel.value : '';
    const PREFIXES = (window.PROVINCE_CITY_PREFIXES) || {};
    
    // 1) ä¸‹æ‹‰ä¼˜å…ˆ
    if (selProvince && PREFIXES[selProvince]) {
      if (selCity && PREFIXES[selProvince][selCity]) {
        targetPrefixes = PREFIXES[selProvince][selCity];
        foundProvince = selProvince; foundCity = selCity;
        console.log(`âœ… ä½¿ç”¨é€‰æ‹©çš„çœå¸‚: ${selProvince}Â·${selCity} â†’ å‰ç¼€:`, targetPrefixes);
      } else {
        // æœªé€‰å¸‚ï¼Œèšåˆè¯¥çœå…¨éƒ¨åŸå¸‚çš„4ä½å‰ç¼€
        targetPrefixes = Object.values(PREFIXES[selProvince]).flat();
        foundProvince = selProvince;
        console.log(`âœ… ä½¿ç”¨é€‰æ‹©çš„çœ: ${selProvince}ï¼ˆæœªé€‰å¸‚ï¼‰ï¼Œèšåˆå‰ç¼€æ•°é‡: ${targetPrefixes.length}`);
      }
    }

    // 2) æœªé€‰æ‹©æ—¶ï¼Œä»å…³é”®è¯ä¸­è¯†åˆ«çœ/å¸‚
    if (targetPrefixes.length === 0) {
      // è¯†åˆ«çœ
      const ALL_PROVS = Object.keys(PREFIXES);
      for (const kw of searchKeywords) {
        const kwBase = canonName(kw);
        const provHit = ALL_PROVS.find(p => {
          const pBase = canonName(p);
          return kwBase.includes(pBase) || pBase.includes(kwBase);
        });
        if (provHit) {
          foundProvince = provHit;
          break;
        }
      }

      if (foundProvince) {
        // è¯†åˆ«å¸‚
        const ALL_CITIES = Object.keys(PREFIXES[foundProvince] || {});
        for (const kw of searchKeywords) {
          const kwBase = canonName(kw);
          const cityHit = ALL_CITIES.find(c => {
            const cBase = canonName(c);
            return kwBase.includes(cBase) || cBase.includes(kwBase);
          });
          if (cityHit) {
            foundCity = cityHit;
            break;
          }
        }

        if (foundCity) {
          targetPrefixes = PREFIXES[foundProvince][foundCity] || [];
          console.log(`âœ… è¯†åˆ«åˆ°åŸå¸‚: ${foundProvince}Â·${foundCity} â†’ å‰ç¼€:`, targetPrefixes);
        } else {
          targetPrefixes = Object.values(PREFIXES[foundProvince] || {}).flat();
          console.log(`âœ… è¯†åˆ«åˆ°çœä»½: ${foundProvince}ï¼ˆæœªè¯†åˆ«å¸‚ï¼‰ï¼Œèšåˆå‰ç¼€æ•°é‡: ${targetPrefixes.length}`);
        }
      }
    }
    
    // è‹¥ä»æœªè¯†åˆ«ä»»ä½•å‰ç¼€ï¼Œæç¤ºç”¨æˆ·é€‰æ‹©çœå¸‚ä»¥é¿å…è¶…å¤§èŒƒå›´æ£€ç´¢
    if (targetPrefixes.length === 0) {
      resultContent.innerHTML = '<p style="text-align:center; color:#f39c12;">âš ï¸ ä¸ºäº†æ•ˆç‡ï¼Œè¯·å…ˆé€‰æ‹©çœä»½ï¼ˆå¯é€‰åŸå¸‚æ›´ä½³ï¼‰ï¼Œå†è¾“å…¥å…³é”®è¯è¿›è¡ŒæŸ¥è¯¢ã€‚</p>';
      return;
    }
    
    // ç”Ÿæˆå®Œæ•´çš„6ä½é‚®ç¼–åˆ—è¡¨ï¼š
    // - è‹¥æ˜¯4ä½å‰ç¼€ï¼ˆç²¾ç¡®åˆ°åŸå¸‚ï¼‰ï¼Œåªæšä¸¾åä¸¤ä½ 00-99ï¼ˆæ¯å‰ç¼€ 100 ä¸ªæ–‡ä»¶ï¼‰
    // - è‹¥æ˜¯2ä½å‰ç¼€ï¼ˆç†è®ºä¸Šä¸å†ä½¿ç”¨ï¼›è‹¥é‡åˆ°åˆ™å›é€€ç”Ÿæˆ 0000-9999ï¼‰
    const allPostcodes = [];
    for (const prefix of targetPrefixes) {
      if (prefix.length === 4) {
        for (let e = 0; e <= 9; e++) {
          for (let f = 0; f <= 9; f++) {
            allPostcodes.push(`${prefix}${e}${f}`);
          }
        }
      } else { // 2ä½å‰ç¼€
        for (let a = 0; a <= 9; a++) {
          for (let b = 0; b <= 9; b++) {
            for (let c = 0; c <= 9; c++) {
              for (let d = 0; d <= 9; d++) {
                allPostcodes.push(`${prefix}${a}${b}${c}${d}`);
              }
            }
          }
        }
      }
    }
    
    console.log(`ğŸ“Š æœç´¢èŒƒå›´: ${allPostcodes.length} ä¸ªé‚®ç¼–æ–‡ä»¶`);
    
    let checkedCount = 0;
    const progressSpan = document.getElementById('searchProgress');
    
    // å¹¶å‘è¯·æ±‚ï¼Œæ¯æ‰¹20ä¸ªï¼ˆå‡å°å•æ‰¹æ—¶é—´ï¼Œè¿›åº¦æ›´å¿«åˆ·æ–°ï¼‰
    const batchSize = 20;
    for (let i = 0; i < allPostcodes.length; i += batchSize) {
      const batch = allPostcodes.slice(i, i + batchSize);
      
      const promises = batch.map(async (code) => {
        try {
          const response = await fetch(`code/${code}.json`);
          if (response.ok) {
            const data = await response.json();
            
            // æœç´¢åŒ¹é…çš„è®°å½• - æŒ‰æƒé‡ç´¯è®¡å‘½ä¸­
            const matched = data.map(item => {
              const fields = {
                province: normalizeText(item.province),
                city: normalizeText(item.city),
                area: normalizeText(item.area),
                name: normalizeText(item.name),
                address: normalizeText(item.address)
              };

              // å•ä¸ªå…³é”®è¯çš„å‘½ä¸­å‘é‡ä¸æƒé‡ï¼ˆæå‡åœ°å€/åç§°çš„æƒé‡ï¼‰
              let fieldScore = 0;
              let keywordHits = 0;
              const weights = { address: 220, name: 160, area: 60, city: 45, province: 30 };

              searchKeywords.forEach(keyword => {
                const kw = normalizeText(keyword);
                let hitThisKeyword = false;

                // åŸè¯åŒ¹é…å„å­—æ®µ
                Object.entries(fields).forEach(([field, value]) => {
                  if (value.includes(kw)) {
                    fieldScore += weights[field];
                    hitThisKeyword = true;
                  }
                });

                // æ‰©å±•å…³é”®è¯åŒ¹é…ï¼ˆç¼©å†™å±•å¼€ï¼‰
                if (!hitThisKeyword && abbreviationMap[keyword]) {
                  abbreviationMap[keyword].forEach(expanded => {
                    const exp = normalizeText(expanded);
                    Object.entries(fields).forEach(([field, value]) => {
                      if (value.includes(exp)) {
                        fieldScore += weights[field] * 0.6; // æ‰©å±•è¯æƒé‡ç•¥ä½
                        hitThisKeyword = true;
                      }
                    });
                  });
                }

                if (hitThisKeyword) {
                  keywordHits += 1;
                }
              });

              // è¦†ç›–ç‡åŠ æˆï¼šå‘½ä¸­è¶Šå¤šå…³é”®è¯ï¼ŒåŠ åˆ†è¶Šå¤š
              const coverageRatio = searchKeywords.length > 0 ? (keywordHits / searchKeywords.length) : 0;
              const coverageBonus = coverageRatio * 200;
              // å…¨è¦†ç›–å¤§é¢å¥–åŠ±ï¼Œç¡®ä¿åŒ¹é…æ‰€æœ‰å…³é”®è¯çš„ç»“æœæ’åœ¨å‰é¢
              const fullCoverBonus = coverageRatio === 1 ? 800 : 0;

              // æ²¡æœ‰ä»»ä½•å‘½ä¸­åˆ™ä¸¢å¼ƒ
              if (fieldScore === 0) return null;

              // è®¡ç®—ç›¸å…³æ€§è¯„åˆ†ï¼ˆå åŠ æ—¢æœ‰ç»†ç²’åº¦è¯„åˆ†ï¼‰
              const relevance = calculateRelevance(item, searchKeywords, expandedKeywords);
              const score = fieldScore + coverageBonus + fullCoverBonus + relevance;

              return { ...item, _relevance: score, _keywordHits: keywordHits };
            }).filter(item => item !== null);
            
            return matched;
          }
        } catch (e) {
          // æ–‡ä»¶ä¸å­˜åœ¨æˆ–è¯»å–å¤±è´¥ï¼Œè¿”å›ç©ºæ•°ç»„
          return [];
        }
        return [];
      }).map(p => p.finally(() => {
        checkedCount += 1;
        if (progressSpan) progressSpan.textContent = checkedCount;
      }));
      
      const batchResults = await Promise.all(promises);
      batchResults.forEach(items => {
        if (items.length > 0) {
          results.push(...items);
        }
      });
      
      // æ‰¾åˆ°è¶³å¤Ÿç»“æœåå¯ä»¥æå‰åœæ­¢
      if (results.length > 200 && foundProvince) {
        console.log(`âœ… å·²æ‰¾åˆ°${results.length}æ¡ç»“æœï¼Œæå‰ç»“æŸæœç´¢`);
        break;
      }
    }
    
    console.log(`ğŸ¯ æœç´¢å®Œæˆï¼Œå…±æ‰¾åˆ° ${results.length} æ¡ç»“æœ`);
    
    // æ˜¾ç¤ºç»“æœ
    if (results.length === 0) {
      resultContent.innerHTML = `
        <p style="text-align:center; color:#f39c12;">
          âŒ æœªæ‰¾åˆ°åŒ…å«æ‰€æœ‰å…³é”®è¯çš„åœ°å€ä¿¡æ¯<br>
          <span style="font-size:14px; color:#666; margin-top:12px; display:block;">
            åŸå§‹è¾“å…¥ï¼š<strong>${keywords}</strong><br>
            åˆ†è¯ç»“æœï¼š${searchKeywords.map(k => `<span style="background:#e3f2fd; padding:2px 6px; border-radius:3px; margin:0 3px;">${k}</span>`).join('')}<br>
            ${foundProvince ? `å·²æœç´¢ ${foundProvince} çœä»½çš„ ${checkedCount} ä¸ªé‚®ç¼–` : `å·²æœç´¢å…¨å›½ ${checkedCount} ä¸ªé‚®ç¼–`}<br>
            <strong style="color:#e74c3c;">æç¤ºï¼šå·²æ”¹ä¸ºæƒé‡åŒ¹é…ï¼Œå¯å°è¯•å¢åŠ æ›´å¤šå…³é”®è¯æé«˜ç›¸å…³åº¦</strong>
          </span>
        </p>
      `;
      return;
    }
    
    // æŒ‰ç›¸å…³æ€§è¯„åˆ†æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼Œå¹¶ä»¥å‘½ä¸­å…³é”®è¯æ•°ä½œä¸ºæ¬¡çº§æ’åº
    results.sort((a, b) => {
      const rel = (b._relevance || 0) - (a._relevance || 0);
      if (rel !== 0) return rel;
      return (b._keywordHits || 0) - (a._keywordHits || 0);
    });
    
    // é™åˆ¶æ˜¾ç¤ºå‰100æ¡æœ€ç›¸å…³ç»“æœ
    const displayResults = results.slice(0, 100);
    
    // å»é‡å¹¶æŒ‰é‚®ç¼–åˆ†ç»„
    const grouped = {};
    displayResults.forEach(item => {
      if (!grouped[item.code]) {
        grouped[item.code] = [];
      }
      grouped[item.code].push(item);
    });
    
    let html = `<h3 style="color:var(--green); margin-top:0;">æ‰¾åˆ° ${results.length} æ¡ç»“æœ${results.length > 100 ? 'ï¼ˆæ˜¾ç¤ºæœ€ç›¸å…³çš„å‰100æ¡ï¼‰' : ''}ï¼Œæ¶‰åŠ ${Object.keys(grouped).length} ä¸ªé‚®ç¼–ï¼š</h3>`;
    
    // æ˜¾ç¤ºåˆ†è¯ç»“æœ
    html += `<p style="font-size:13px; color:#666; margin-bottom:8px;">ğŸ” åˆ†è¯ç»“æœï¼š${searchKeywords.map(k => `<span style="background:#e3f2fd; padding:2px 6px; border-radius:3px; margin:0 3px;">${k}</span>`).join('')}</p>`;
    
    // æ·»åŠ æœç´¢å…³é”®è¯æç¤º
    if (expandedKeywords.length > searchKeywords.length) {
      const extraKeywords = expandedKeywords.filter(k => !searchKeywords.includes(k));
      html += `<p style="font-size:13px; color:#666; margin-bottom:12px;">ğŸ’¡ æ‰©å±•æœç´¢ï¼š${extraKeywords.join('ã€')}</p>`;
    }
    
    html += '<div style="max-height:500px; overflow-y:auto;">';
    
    // æŒ‰â€œè¯¥é‚®ç¼–ä¸‹æœ€é«˜ç›¸å…³æ€§â€æ’åºï¼Œé¿å…è¢«é‚®ç¼–æ•°å­—é¡ºåºæ‰“ä¹±
    const sortedCodes = Object.keys(grouped).sort((codeA, codeB) => {
      const bestA = Math.max(...grouped[codeA].map(x => x._relevance || 0));
      const bestB = Math.max(...grouped[codeB].map(x => x._relevance || 0));
      return bestB - bestA;
    });
    
    sortedCodes.forEach(code => {
      // å¯¹åŒä¸€é‚®ç¼–å†…çš„ç»“æœä¹ŸæŒ‰ç›¸å…³æ€§æ’åº
      grouped[code].sort((a, b) => (b._relevance || 0) - (a._relevance || 0));
      
      html += `<div style="background:#e8f5e9; border-radius:8px; padding:12px; margin-bottom:16px; border-left:4px solid var(--light-green);">`;
      html += `<div style="font-size:20px; font-weight:bold; color:var(--light-green); margin-bottom:12px;">é‚®ç¼–ï¼š${code}</div>`;
      
      grouped[code].forEach((item, idx) => {
        // é«˜äº®åŒ¹é…çš„å…³é”®è¯
        let highlightedAddress = item.address;
        let highlightedName = item.name;
        
        const escapeRegExp = (s) => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const highlightKeywords = [...new Set([...searchKeywords, ...expandedKeywords].map(k => normalizeText(k)).filter(Boolean))];

        highlightKeywords.forEach(keyword => {
          const regex = new RegExp(`(${escapeRegExp(keyword)})`, 'gi');
          highlightedAddress = highlightedAddress.replace(regex, '<mark style="background:#fff59d; padding:0 2px;">$1</mark>');
          highlightedName = highlightedName.replace(regex, '<mark style="background:#fff59d; padding:0 2px;">$1</mark>');
        });
        
        html += `
          <div style="background:#fff; border-radius:6px; padding:12px; margin-bottom:8px; position:relative;">
            ${item._relevance > 80 ? '<span style="position:absolute; top:8px; right:8px; background:#4caf50; color:white; padding:2px 6px; border-radius:3px; font-size:11px;">é«˜åº¦ç›¸å…³</span>' : ''}
            <div style="font-size:16px; font-weight:bold; color:var(--green); margin-bottom:6px;">
              ${highlightedName}
            </div>
            <div style="font-size:14px; margin-bottom:3px;">
              <strong>åœ°åŒºï¼š</strong>${item.province} ${item.city} ${item.area}
            </div>
            <div style="font-size:14px; margin-bottom:3px;">
              <strong>åœ°å€ï¼š</strong>${highlightedAddress}
            </div>
            <div style="font-size:14px;">
              <strong>ç”µè¯ï¼š</strong>${item.phone}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
    });
    
    html += '</div>';
    resultContent.innerHTML = html;
    
  } catch (error) {
    console.error('æŸ¥è¯¢å‡ºé”™:', error);
    resultContent.innerHTML = `<p style="text-align:center; color:#e74c3c;">âŒ æŸ¥è¯¢å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•</p>`;
  }
}

// ====== äº‹ä»¶ç»‘å®š ======
document.addEventListener('DOMContentLoaded', function() {
  // é‚®ç¼–æŸ¥è¯¢æŒ‰é’®
  document.getElementById('queryCodeBtn').addEventListener('click', queryByPostcode);
  document.getElementById('postcodeInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      queryByPostcode();
    }
  });
  
  // åœ°å€æŸ¥è¯¢æŒ‰é’®
  document.getElementById('queryAddressBtn').addEventListener('click', queryByAddress);
  document.getElementById('addressInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      queryByAddress();
    }
  });

  // åˆå§‹åŒ–çœå¸‚ä¸‹æ‹‰
  try { initProvinceCityDropdowns(); } catch (e) { console.warn('çœå¸‚ä¸‹æ‹‰åˆå§‹åŒ–å¤±è´¥', e); }
});
</script>

<style>
.query-result {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  margin-top: 24px;
  box-shadow: 0 2px 12px #e0e0e0;
  animation: fadeIn 0.5s ease;
}

#resultContent {
  font-size: 14px;
  line-height: 1.6;
}
</style>

</body>
</html>
